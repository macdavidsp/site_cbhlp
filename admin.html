<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Administração</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="supabase.js"></script>
</head>
<body>
  <header>
    <h1>Painel Administrativo</h1>
    <nav>
      <ul>
        <li><a href="index.html">Início</a></li>
        <li><a href="cadastro.html">Registro</a></li>
        <li><a href="verificar.html">Verificação</a></li>
        <li><a href="quorum.html">Quórum</a></li>
        <li><a href="admin.html">Admin</a></li>
      </ul>
    </nav>
  </header>
  <main>
    <div id="loginArea">
      <h2>Login do Administrador</h2>
      <form id="loginForm">
        <input type="text" name="usuario" placeholder="Usuário" required />
        <input type="password" name="senha" placeholder="Senha" required />
        <button type="submit">Entrar</button>
      </form>
      <p id="loginMensagem"></p>
    </div>

    <div id="adminArea" style="display:none;">
      <h2>Reunião Ativa</h2>
      <button onclick="registrarReuniao()">Registrar nova reunião</button>
      <p id="reuniaoStatus"></p>

      <h2>Presenças da reunião atual</h2>
      <ul id="listaPresencas"></ul>

      <h2>Consultar reuniões anteriores</h2>
      <select id="reunioesPassadas" onchange="listarPresencasPassadas(this.value)">
        <option value="">Selecione uma data</option>
      </select>
      <ul id="listaPassada"></ul>
    </div>
  </main>

  <script>
    const loginForm = document.getElementById("loginForm");
    const loginMensagem = document.getElementById("loginMensagem");
    const loginArea = document.getElementById("loginArea");
    const adminArea = document.getElementById("adminArea");

    loginForm.addEventListener("submit", function(e) {
      e.preventDefault();
      const dados = Object.fromEntries(new FormData(this));
      if (dados.usuario === "admin" && dados.senha === "cbhlp2025") {
        loginArea.style.display = "none";
        adminArea.style.display = "block";
        carregarAdmin();
      } else {
        loginMensagem.textContent = "Usuário ou senha incorretos.";
        loginMensagem.style.color = "red";
      }
    });

    async function registrarReuniao() {
      const hoje = new Date().toISOString().split("T")[0];
      await supabase.from("reunioes").update({ ativa: false }).eq("ativa", true);
      const { error } = await supabase.from("reunioes").insert([{ data_reuniao: hoje, ativa: true }]);
      document.getElementById("reuniaoStatus").textContent = error ? "Erro ao registrar reunião." : "Reunião registrada com sucesso!";
      carregarAdmin();
    }

    async function carregarAdmin() {
      const { data: ativa } = await supabase.from("reunioes").select("data_reuniao").eq("ativa", true).single();
      const dataAtual = ativa?.data_reuniao;
      document.getElementById("reuniaoStatus").textContent = dataAtual ? `Reunião ativa: ${dataAtual}` : "Nenhuma reunião ativa.";

      const { data: presencas } = await supabase.from("presencas").select("*").eq("data_reuniao", dataAtual);
      const lista = document.getElementById("listaPresencas");
      lista.innerHTML = presencas.map(p => `<li>${p.nome} (${p.instituicao}) - ${p.setor} / ${p.representacao}</li>`).join("");

      const { data: reunioes } = await supabase.from("reunioes").select("data_reuniao").order("data_reuniao", { ascending: false });
      const select = document.getElementById("reunioesPassadas");
      select.innerHTML = `<option value="">Selecione uma data</option>` + reunioes.map(r => `<option value="${r.data_reuniao}">${r.data_reuniao}</option>`).join("");
    }

    async function listarPresencasPassadas(data) {
      const { data: presencas } = await supabase.from("presencas").select("*").eq("data_reuniao", data);
      const lista = document.getElementById("listaPassada");
      lista.innerHTML = presencas.map(p => `<li>${p.nome} (${p.instituicao}) - ${p.setor} / ${p.representacao}</li>`).join("");
    }
  </script>
</body>
</html>