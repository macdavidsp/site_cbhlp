<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Frequência e Quórum</title>
    
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Bibliotecas JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Adiciona a biblioteca jspdf-autotable para tabelas formatadas no PDF -->
    <script src="https://unpkg.com/jspdf-autotable@3.5.21/dist/jspdf.plugin.autotable.js"></script>
    
    <!-- Configuração do Tailwind com a Paleta de Cores -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-primary': '#176781', // Dark Teal/Blue-Grey
                        'brand-accent': '#eac066', // Gold/Yellow (Highlight)
                        'brand-neutral': '#67686a', // Medium Grey
                        'brand-success': '#50c2ab', // Seafoam Green
                        'brand-light': '#7fb2c7',  // Soft Blue
                    },
                },
            },
        }
    </script>

    <!-- Estilos Customizados -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* --- ESTILO ATUALIZADO DO BOTÃO PRINCIPAL (REGISTRO/ADMIN) --- */
        .btn-primary {
            /* Layout alignment */
            @apply w-full flex items-center justify-center space-x-3 text-lg; 
            /* Enhanced Design: Gradient, strong shadow, larger text */
            @apply bg-gradient-to-r from-brand-primary to-brand-success text-white font-extrabold py-4 px-6 rounded-xl shadow-xl hover:shadow-2xl hover:from-brand-primary/90 hover:to-brand-success/90 transition duration-300 ease-in-out transform hover:scale-[1.01];
        }

        /* Botão Vermelho para Finalizar */
        .btn-danger {
            @apply w-full flex items-center justify-center space-x-3 text-lg; 
            @apply bg-red-600 text-white font-extrabold py-4 px-6 rounded-xl shadow-xl hover:shadow-2xl hover:bg-red-700 transition duration-300 ease-in-out transform hover:scale-[1.01];
        }
        
        /* --- ESTILO DE INPUT APRIMORADO COM BORDAS MAIS CLARAS E DISCRETAS --- */
        .input-field {
            /* Border verde (#4ac0a7) e foco aprimorado */
            @apply w-full px-4 py-3 border border-[#4ac0a7] rounded-lg focus:outline-none focus:ring-4 focus:ring-brand-accent/30 focus:border-brand-primary transition duration-200 shadow-sm hover:shadow-md text-base;
        }

        /* Ajuste específico para dropdowns para garantir tamanho de fonte base e remover appearance-none */
        .input-field.select-field {
            @apply text-base; 
        }
        
        /* --- ESTILO DO CARD DE CONTEÚDO (O cartão principal branco) --- */
        .container-card {
            /* Adicionado um fundo suave para contraste e borda mais nítida */
            @apply p-6 md:p-10 bg-white shadow-2xl rounded-3xl max-w-4xl w-full mx-auto my-8 border border-brand-light/50;
        }
        
        /* --- ESTILO DO CARD DE MENU --- */
        .menu-card-btn {
            /* Hover mais distinto */
            @apply flex flex-col items-center justify-center p-6 bg-white border-2 border-brand-light rounded-2xl shadow-lg hover:shadow-xl hover:border-brand-accent text-center cursor-pointer transition duration-300 transform hover:scale-[1.03];
        }

        /* Título de Seção */
        .section-title {
            /* Título com a cor de destaque */
            @apply text-3xl font-extrabold mb-8 text-gray-800 border-b-4 border-brand-accent/50 pb-2 text-center;
        }

        /* Estilo para Tabela de Admin */
        .admin-table tbody tr:nth-child(odd) {
            background-color: #f9fafb; /* Lighter background for odd rows */
        }
        .admin-table tbody tr:hover {
            background-color: #f3f4f6; /* Subtle hover effect */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="app" class="flex flex-col min-h-screen">
        
        <!-- Mensagem de Status (Feedback) -->
        <div id="status-message" class="fixed top-4 right-4 p-4 rounded-xl shadow-2xl text-white font-medium transition-opacity duration-300 opacity-0 z-50 pointer-events-none" style="min-width: 300px;"></div>
        
        <!-- Estado da Reunião (Barra no topo, visível em todas as telas) -->
        <div id="meeting-status-bar" class="bg-brand-primary/90 text-white text-center py-2 shadow-inner sticky top-0 z-40">
            <span class="font-semibold" id="meeting-name-display">Carregando Estado...</span> 
            <span id="meeting-status-badge" class="ml-2 px-3 py-1 text-xs font-bold rounded-full"></span>
        </div>

        <!-- Cabeçalho (Botão para voltar ao Menu Principal) -->
        <header id="main-header" class="bg-white py-8 shadow-md mb-8 cursor-pointer hover:shadow-lg transition duration-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                
                <img 
                    src="logo.png" 
                    alt="Logo da Reunião" 
                    class="mx-auto h-32 sm:h-40 object-contain" 
                    onerror="this.onerror=null;this.src='https://placehold.co/200x72/176781/ffffff?text=LOGO'"
                >
                <h1 class="mt-4 text-4xl md:text-5xl font-extrabold text-gray-900 tracking-tight">
                    <span class="text-brand-primary">Sistema de Gestão On-line</span> de Reuniões
                </h1>
                <p class="mt-2 text-xl text-gray-500">
                    Clique aqui para voltar ao Menu Principal.
                </p>
            </div>
        </header>

        <main class="flex-grow p-4 sm:p-6 lg:p-8">

            <!-- 1. Menu Principal -->
            <section id="main-cards-view" class="view-section container-card">
                <h2 class="section-title text-brand-primary">Selecione a Ação Desejada</h2>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    
                    <button class="menu-card-btn" data-target="registro">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus text-brand-primary mb-3"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
                        <span class="text-xl font-semibold text-gray-800">Registro</span>
                        <span class="text-sm text-brand-neutral">Marcar Presença</span>
                    </button>

                    <button class="menu-card-btn" data-target="quorum">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pie-chart text-brand-success mb-3"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                        <span class="text-xl font-semibold text-gray-800">Quórum</span>
                        <span class="text-sm text-brand-neutral">Ver Status</span>
                    </button>

                    <button class="menu-card-btn" data-target="validacao">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-key-round text-brand-accent mb-3"><path d="M2 18L5 21L12 14L9 11L2 18Z"/><path d="M15 10L18 7L21 4"/><path d="M12 14L15 11"/><path d="M18 7L21 10"/></svg>
                        <span class="text-xl font-semibold text-gray-800">Validação</span>
                        <span class="text-sm text-brand-neutral">Verificar Código</span>
                    </button>

                    <button class="menu-card-btn" data-target="admin-login">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lock text-brand-neutral mb-3"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        <span class="text-xl font-semibold text-gray-800">Admin</span>
                        <span class="text-sm text-brand-neutral">Acesso Restrito</span>
                    </button>
                </div>
            </section>

            <!-- 2. Formulário de Registro (PRESENÇA) -->
            <section id="registro" class="view-section container-card hidden">
                <h2 class="section-title text-brand-accent">Seus Dados de Presença</h2>
                
                <div id="registration-closed-message" class="hidden p-6 bg-red-100 text-red-700 border-l-4 border-red-500 rounded-lg mb-6 font-semibold">
                    <p class="text-lg">Registro Fechado:</p>
                    <p>O registro de frequência está fechado. Peça ao administrador para iniciar a reunião.</p>
                </div>
                
                <form id="registration-form" class="space-y-6 p-6 bg-brand-light/30 rounded-2xl shadow-lg">
                    
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                        <input type="text" id="name" required class="input-field" placeholder="Seu Nome">
                    </div>

                    <div>
                        <label for="cpf" class="block text-sm font-medium text-gray-700 mb-1">CPF (apenas números)</label>
                        <input type="text" id="cpf" required pattern="\d{11}" maxlength="11" title="CPF deve ter 11 dígitos numéricos." class="input-field" placeholder="Ex: 12345678900">
                    </div>

                    <div>
                        <label for="institution" class="block text-sm font-medium text-gray-700 mb-1">Instituição / Órgão</label>
                        <input type="text" id="institution" required class="input-field" placeholder="Nome da Instituição">
                    </div>

                    <div class="grid grid-cols-1 gap-4"> 
                        <div>
                            <label for="sector" class="block text-sm font-medium text-gray-700 mb-1">Setor</label>
                            <select id="sector" required class="input-field select-field">
                                <option value="">Selecione o Setor</option>
                                <option value="Usuario">Usuário</option>
                                <option value="Poder Público">Poder Público</option>
                                <option value="Sociedade Civil">Sociedade Civil</option>
                            </select>
                        </div>
                        <div>
                            <label for="representation" class="block text-sm font-medium text-gray-700 mb-1">Representação</label>
                            <select id="representation" required class="input-field select-field">
                                <option value="">Selecione a Repr.</option>
                                <option value="Titular">Titular</option>
                                <option value="Suplente">Suplente</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="pt-4">
                        <button type="submit" class="btn-primary w-full" id="register-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M9 11l3 3L22 4"/></svg>
                            <span>Confirmar e Registrar Presença</span>
                        </button>
                    </div>
                </form>
            </section>

            <!-- 3. Quórum (GRÁFICOS) -->
            <section id="quorum" class="view-section container-card hidden">
                <h2 class="section-title text-brand-accent">Acompanhamento do Quórum</h2>
                
                <div class="mb-4 p-4 bg-brand-light/30 rounded-xl text-center shadow-lg">
                    <p id="quorum-meeting-name" class="text-xl font-bold text-brand-primary">Carregando dados da Reunião...</p>
                </div>

                <div class="mb-8 bg-brand-light/30 p-6 rounded-xl shadow-lg flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                    <p class="text-xl font-medium text-gray-700">Início da Reunião: <span id="current-date" class="text-brand-primary font-bold">--</span></p>
                    <p class="text-xl font-medium text-gray-700">Total de Presentes:</p>
                    <span id="total-presentes" class="text-brand-success font-extrabold text-4xl p-2 rounded-lg bg-white shadow-inner">0</span>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-brand-light/30 p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-semibold mb-3 text-brand-neutral border-b pb-2">Distribuição por Setor</h3>
                        <canvas id="sectorChart" class="w-full"></canvas>
                    </div>
                    <div class="bg-brand-light/30 p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-semibold mb-3 text-brand-neutral border-b pb-2">Distribuição por Representação</h3>
                        <canvas id="representationChart" class="w-full"></canvas>
                    </div>
                </div>
            </section>

            <!-- 4. Login Admin -->
            <section id="admin-login" class="view-section container-card hidden max-w-md">
                <h2 class="section-title text-brand-accent">Acesso de Administrador</h2>
                <form id="admin-login-form" class="space-y-6 p-6 bg-brand-light/30 rounded-xl shadow-lg">
                    <div>
                        <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">Senha de Administrador</label>
                        <input type="password" id="admin-password" required class="input-field" placeholder="Digite a senha">
                    </div>
                    
                    <button type="submit" class="btn-primary w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-in"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
                        <span>Acessar Dashboard</span>
                    </button>
                    <p class="text-sm text-red-600 mt-2 text-center font-semibold" id="admin-login-error"></p>
                </form>
            </section>

            <!-- 5. Dashboard Admin -->
            <section id="admin-dashboard" class="view-section container-card hidden">
                
                <!-- NOVO: Controles da Reunião -->
                <div class="mb-8 p-6 bg-brand-light/30 rounded-xl shadow-lg border border-brand-light">
                    <h3 class="text-xl font-bold text-brand-primary mb-4 border-b pb-2">Controle da Reunião</h3>
                    
                    <div class="flex flex-col md:flex-row justify-between items-start sm:items-center mb-4 space-y-3 md:space-y-0">
                        <div id="admin-status-badge-container" class="text-lg font-semibold flex items-center space-x-2">
                             <!-- Status será injetado aqui -->
                        </div>
                        <p class="text-base text-gray-700 italic" id="admin-meeting-info">Informações da reunião atual serão exibidas aqui.</p>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button id="start-meeting-btn" class="btn-primary py-3 text-base hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play-circle"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>
                            <span>INICIAR NOVA REUNIÃO</span>
                        </button>
                        <button id="end-meeting-btn" class="btn-danger py-3 text-base hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>
                            <span>FINALIZAR REUNIÃO</span>
                        </button>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-2 border-brand-accent/50">
                    <h2 class="text-3xl font-extrabold text-brand-primary mb-3 sm:mb-0">Registros Detalhados</h2>
                    <div class="flex space-x-3">
                        <button id="download-csv" class="btn-primary py-2 px-4 text-sm font-semibold hover:bg-brand-primary/90">Download CSV</button>
                        <button id="download-pdf" class="btn-primary py-2 px-4 text-sm font-semibold hover:bg-brand-primary/90">Download PDF</button>
                    </div>
                </div>

                <div class="overflow-x-auto bg-brand-light/30 rounded-xl shadow-lg p-4 border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200 admin-table">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider rounded-tl-lg">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Nome</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">CPF</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Setor</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Rep.</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Cód. Validação</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider rounded-tr-lg">Data/Hora</th>
                            </tr>
                        </thead>
                        <tbody id="admin-table-body" class="divide-y divide-gray-100">
                            <!-- Registros inseridos via JS -->
                        </tbody>
                    </table>
                    <p id="admin-loading-message" class="text-center py-4 text-gray-500">Carregando dados...</p>
                </div>
            </section>

            <!-- 6. Validação de Código -->
            <section id="validacao" class="view-section container-card hidden max-w-md">
                <h2 class="section-title text-brand-accent">Verificação de Validação</h2>
                <form id="validation-form" class="space-y-4 p-6 bg-brand-light/30 rounded-xl shadow-lg">
                    <div>
                        <label for="validation-code-input" class="block text-sm font-medium text-gray-700 mb-1">Código de Validação</label>
                        <input type="text" id="validation-code-input" required class="input-field text-xl text-center tracking-widest" maxlength="6" placeholder="______">
                    </div>
                    
                    <button type="submit" class="btn-primary w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-check"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 13 2 2 4-4"/></svg>
                        <span>Validar Código</span>
                    </button>
                </form>
                
                <div id="validation-result" class="mt-6 p-6 rounded-xl text-brand-primary font-medium hidden shadow-xl border-l-4 border-brand-accent">
                    <!-- Resultado da validação aparece aqui -->
                </div>
            </section>

        </main>
        
        <!-- Rodapé -->
        <footer class="bg-gray-800 text-white p-4 text-center text-sm mt-8">
            Sistema de Registro de Frequência | Desenvolvido com Firebase & Tailwind CSS
        </footer>
    </div>

    <!-- Script JavaScript (Módulo) -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, runTransaction, doc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Configurações e Variáveis Globais (MANDATÓRIO) ---
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const ADMIN_PASSWORD = "minhasenhasecreta123";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        setLogLevel('debug'); 

        let userId = null;
        let isAuthReady = false;
        let registrationsData = []; // Cache dos dados de registro da reunião ATUAL

        // Caminho da Coleção para Registros
        const REGISTRATIONS_COLLECTION_PATH = `artifacts/${appId}/public/data/meeting_registrations`;
        
        // Documento para o estado da reunião
        const MEETING_STATE_DOC_REF = doc(db, `artifacts/${appId}/public/data/meeting_state/current_meeting`);
        
        // Estado da reunião em memória
        let currentMeetingState = { 
            isActive: false, 
            meetingId: null, 
            meetingName: 'Aguardando Início', 
            startDate: null 
        };
        
        // --- Funções de Utilitário ---
        function showStatusMessage(message, isError = false) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = 'fixed top-4 right-4 p-4 rounded-xl shadow-2xl font-medium transition-opacity duration-300 z-50';
            
            if (isError) {
                statusEl.classList.add('bg-red-600', 'text-white');
            } else {
                statusEl.classList.add('bg-brand-success', 'text-white'); 
            }
            
            statusEl.classList.remove('opacity-0', 'pointer-events-none');
            statusEl.classList.add('opacity-100');

            setTimeout(() => {
                statusEl.classList.remove('opacity-100');
                statusEl.classList.add('opacity-0', 'pointer-events-none');
            }, 5000);
        }

        function generateValidationCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        function formatDate(timestamp) {
            if (!timestamp) return '--';
            const dateObj = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        function formatDateTime(timestamp) {
            if (!timestamp) return '--';
            const dateObj = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return dateObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }


        // --- 1. Lógica de Autenticação (Setup Inicial) ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Erro na autenticação inicial:", error);
                }
            }
            isAuthReady = true;
            setupMeetingStateListener(); // Começa a ouvir o estado da reunião
        });

        // --- 2. Controle de Navegação (SPA) ---
        const viewSections = document.querySelectorAll('.view-section');
        
        function switchView(targetId) {
            viewSections.forEach(section => {
                section.classList.add('hidden');
            });
            const targetElement = document.getElementById(targetId);
            if(targetElement) {
                targetElement.classList.remove('hidden');
            }
            
            // Certifica-se de que se não for a main-cards-view, ela está escondida
            if (targetId !== 'main-cards-view') {
                 document.getElementById('main-cards-view').classList.add('hidden');
            }
            
            // Atualiza a visualização do Quorum/Admin se necessário (o listener de estado cuida do resto)
            if (targetId === 'quorum') {
                updateQuorumView();
            } else if (targetId === 'admin-dashboard') {
                updateAdminDashboardUI();
            }
        }
        
        function handleViewSwitch(requestedTarget) {
            let targetId = requestedTarget;
            
            if (requestedTarget === 'admin-login') {
                 // Verifica se o dashboard já está visível (se o usuário já logou)
                 if (!document.getElementById('admin-dashboard').classList.contains('hidden')) {
                     targetId = 'admin-dashboard'; 
                 } else {
                     targetId = 'admin-login'; 
                 }
            }
            switchView(targetId);
        }

        document.addEventListener('DOMContentLoaded', () => {
            switchView('main-cards-view'); 
            document.getElementById('main-header').addEventListener('click', () => {
                switchView('main-cards-view');
            });
            document.addEventListener('click', (e) => {
                const card = e.target.closest('.menu-card-btn');
                if (card) {
                    handleViewSwitch(card.dataset.target);
                }
            });
        });
        
        // --- 3. Lógica do Estado da Reunião (NOVA FUNÇÃO CHAVE) ---

        function updateRegistrationFormVisibility() {
            const form = document.getElementById('registration-form');
            const message = document.getElementById('registration-closed-message');
            
            if (currentMeetingState.isActive) {
                form.classList.remove('hidden');
                message.classList.add('hidden');
            } else {
                form.classList.add('hidden');
                message.classList.remove('hidden');
            }
        }

        function updateStatusBar() {
            const badge = document.getElementById('meeting-status-badge');
            const nameDisplay = document.getElementById('meeting-name-display');
            const status = currentMeetingState.isActive ? 'ABERTA' : 'FECHADA';
            
            nameDisplay.textContent = currentMeetingState.meetingName;
            badge.textContent = status;

            badge.className = 'ml-2 px-3 py-1 text-xs font-bold rounded-full transition-colors duration-300';
            if (currentMeetingState.isActive) {
                badge.classList.add('bg-brand-success', 'text-gray-900');
            } else {
                badge.classList.add('bg-red-400', 'text-white');
            }
            
            updateRegistrationFormVisibility();
        }
        
        function setupMeetingStateListener() {
            if (!isAuthReady) return;

            onSnapshot(MEETING_STATE_DOC_REF, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    currentMeetingState = { 
                        isActive: false, // Default seguro
                        meetingId: null,
                        meetingName: 'Aguardando Início',
                        startDate: null,
                        ...docSnapshot.data() 
                    };
                } else {
                    // Se o documento não existir, crie um estado inicial fechado
                    currentMeetingState = { 
                        isActive: false, 
                        meetingId: null, 
                        meetingName: 'Aguardando Início', 
                        startDate: null 
                    };
                    // Tenta criar o documento inicial no Firestore se ele não existir
                    setDoc(MEETING_STATE_DOC_REF, currentMeetingState, { merge: true }).catch(e => console.error("Erro ao inicializar o doc de estado:", e));
                }
                
                console.log("Estado da reunião atualizado:", currentMeetingState);
                updateStatusBar(); // Atualiza a barra de status global
                updateAdminDashboardUI(); // Atualiza botões do Admin

                // Chama o listener de quórum com o ID da reunião atual
                const targetMeetingId = currentMeetingState.meetingId;
                if (targetMeetingId) {
                    setupQuorumListener(targetMeetingId);
                } else {
                    // Limpa dados e gráficos se não houver reunião (pré-início)
                    registrationsData = [];
                    updateQuorumCharts(registrationsData);
                    renderAdminTable(registrationsData);
                }
                
            }, (error) => {
                console.error("Erro ao ouvir estado da reunião:", error);
                showStatusMessage("Erro ao carregar estado da reunião. Verifique as Regras de Segurança.", true);
            });
        }

        // --- 4. Lógica do Formulário de Registro (Corrigida Novamente) ---
        
        document.getElementById('registration-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthReady) {
                showStatusMessage("Aguarde a inicialização do sistema...", true);
                return;
            }
            
            // Verifica se a reunião está ativa
            if (!currentMeetingState.isActive || !currentMeetingState.meetingId) {
                showStatusMessage("O registro está fechado. A reunião não está ativa.", true);
                return;
            }

            const name = document.getElementById('name').value.trim();
            const cpf = document.getElementById('cpf').value.trim();
            const institution = document.getElementById('institution').value.trim();
            const sector = document.getElementById('sector').value;
            const representation = document.getElementById('representation').value;
            
            const validationCode = generateValidationCode();
            
            try {
                // Define a Collection Reference dentro do escopo da função
                const registrationsRef = collection(db, REGISTRATIONS_COLLECTION_PATH); 
                
                // 1. Cria a referência do novo documento
                const newRegistrationDocRef = doc(registrationsRef);
                
                // 2. Query para verificar duplicidade, focada apenas no CPF na reunião atual.
                const q = query(registrationsRef, 
                                where("cpf", "==", cpf), 
                                where("meetingId", "==", currentMeetingState.meetingId));

                // CORREÇÃO: Faz a verificação de duplicidade ANTES da transação.
                // A função transaction.get() não pode receber um objeto Query, causando o erro 'path'.
                const preCheckSnapshot = await getDocs(q); 
                if (!preCheckSnapshot.empty) {
                    throw new Error("Duplicidade detectada."); 
                }
                
                // 3. Registrar Transação (APENAS O WRITE AGORA)
                await runTransaction(db, async (transaction) => {
                    
                    // Nota: A verificação de duplicidade (leitura) foi feita acima. 
                    // A transação agora foca na escrita atômica do novo documento.
                    
                    const newRegistration = {
                        name,
                        cpf,
                        institution,
                        sector,
                        representation,
                        validationCode,
                        meetingId: currentMeetingState.meetingId, 
                        date: formatDate(currentMeetingState.startDate), 
                        timestamp: new Date().toISOString() // Salva como ISO string
                    };
                    
                    // 4. Usa a referência do documento gerada antes da transação
                    transaction.set(newRegistrationDocRef, newRegistration);
                    
                });
                
                // Feedback após transação bem sucedida
                showStatusMessage(`Presença registrada! Código de Validação: ${validationCode}`, false);
                document.getElementById('registration-form').reset(); 
                switchView('main-cards-view'); 

            } catch (error) {
                if (error.message === "Duplicidade detectada.") {
                    showStatusMessage(`Duplicidade: Seu CPF já foi registrado nesta reunião.`, true);
                } else {
                    console.error("Erro CRÍTICO ao registrar a frequência:", error);
                    showStatusMessage(`Erro ao registrar: ${error.message || 'Verifique o console para detalhes.'}`, true);
                }
            }
        });

        // --- 5. Lógica do Gráfico de Quórum (Atualizado para meetingId) ---
        
        let sectorChart = null;
        let representationChart = null;
        const chartColors = ['#176781', '#eac066', '#50c2ab', '#7fb2c7', '#67686a'];

        function updateQuorumCharts(data) {
            document.getElementById('total-presentes').textContent = data.length;
            
            const startDateFormatted = currentMeetingState.startDate ? formatDate(currentMeetingState.startDate) : '--';
            document.getElementById('current-date').textContent = startDateFormatted;
            document.getElementById('quorum-meeting-name').textContent = `Dados da Reunião: ${currentMeetingState.meetingName}`;


            // Agrega dados por Setor
            const sectorCounts = data.reduce((acc, curr) => {
                acc[curr.sector] = (acc[curr.sector] || 0) + 1;
                return acc;
            }, {});
            
            // Agrega dados por Representação
            const representationCounts = data.reduce((acc, curr) => {
                acc[curr.representation] = (acc[curr.representation] || 0) + 1;
                return acc;
            }, {});

            const sectorLabels = Object.keys(sectorCounts);
            const sectorValues = Object.values(sectorCounts);
            const repLabels = Object.keys(representationCounts);
            const repValues = Object.values(representationCounts);
            
            // Atualiza Gráfico de Setores
            if (sectorChart) sectorChart.destroy();
            const sectorCtx = document.getElementById('sectorChart').getContext('2d');
            sectorChart = new Chart(sectorCtx, {
                type: 'pie',
                data: {
                    labels: sectorLabels,
                    datasets: [{
                        label: 'Presença por Setor',
                        data: sectorValues,
                        backgroundColor: sectorLabels.map((_, i) => chartColors[i % chartColors.length]),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' }, title: { display: false } }
                }
            });
            
            // Atualiza Gráfico de Representação
            if (representationChart) representationChart.destroy();
            const repCtx = document.getElementById('representationChart').getContext('2d');
            representationChart = new Chart(repCtx, {
                type: 'doughnut',
                data: {
                    labels: repLabels,
                    datasets: [{
                        label: 'Presença por Representação',
                        data: repValues,
                        backgroundColor: repLabels.map((_, i) => chartColors[i % chartColors.length]),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' }, title: { display: false } }
                }
            });
        }
        
        // Listener em Tempo Real (onSnapshot) para Quórum
        function setupQuorumListener(meetingId) {
            if (!isAuthReady || !meetingId) {
                return;
            }
            
            // Define a Collection Reference dentro da função
            const registrationsRef = collection(db, REGISTRATIONS_COLLECTION_PATH); 
            
            // Query filtrada pelo meetingId
            const q = query(registrationsRef, where("meetingId", "==", meetingId));
            
            onSnapshot(q, (snapshot) => {
                registrationsData = [];
                snapshot.forEach((doc) => {
                    registrationsData.push({ id: doc.id, ...doc.data() });
                });
                
                // Atualiza a view do Quorum/Admin
                updateQuorumCharts(registrationsData);
                renderAdminTable(registrationsData); 
            }, (error) => {
                console.error("Erro ao ouvir atualizações do Quórum:", error);
                showStatusMessage("Erro ao carregar dados do quórum.", true);
            });
        }

        function updateQuorumView() {
            // A atualização do nome da reunião é feita em updateQuorumCharts()
        }


        // --- 6. Lógica da Área Administrativa (Controle de Reunião) ---

        // 6.1 Login
        document.getElementById('admin-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('admin-login-error');
            
            if (password === ADMIN_PASSWORD) {
                errorEl.textContent = "";
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                updateAdminDashboardUI(); // Atualiza a UI do dashboard imediatamente após o login
            } else {
                errorEl.textContent = "Senha incorreta. Tente novamente.";
                showStatusMessage("Senha de Admin incorreta.", true);
            }
        });

        // 6.2 Renderização da Tabela
        function renderAdminTable(data) {
            const tableBody = document.getElementById('admin-table-body');
            const loadingMsg = document.getElementById('admin-loading-message');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                loadingMsg.textContent = "Nenhum registro encontrado para esta reunião.";
                loadingMsg.classList.remove('hidden');
                return;
            }
            loadingMsg.classList.add('hidden');

            // Ordena os dados pela data de registro (timestamp) mais recente
            data.sort((a, b) => {
                const dateA = new Date(a.timestamp);
                const dateB = new Date(b.timestamp);
                return dateB - dateA;
            });

            data.forEach(reg => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-100 transition duration-150';
                
                const timeString = formatDateTime(reg.timestamp);
                
                row.insertCell().textContent = reg.id.substring(0, 4) + '...'; 
                row.insertCell().textContent = reg.name;
                row.insertCell().textContent = reg.cpf;
                row.insertCell().textContent = reg.sector;
                row.insertCell().textContent = reg.representation;
                row.insertCell().textContent = reg.validationCode;
                row.insertCell().textContent = `${reg.date} (${timeString})`;
            });
        }
        
        // 6.3 Atualização da UI do Dashboard (Botões/Status)
        function updateAdminDashboardUI() {
            const statusContainer = document.getElementById('admin-status-badge-container');
            const infoEl = document.getElementById('admin-meeting-info');
            const startBtn = document.getElementById('start-meeting-btn');
            const endBtn = document.getElementById('end-meeting-btn');
            
            // Limpa o container
            statusContainer.innerHTML = '';

            const statusText = currentMeetingState.isActive ? 'Reunião ATIVA (Registros Abertos)' : 'Reunião FECHADA (Registros Suspensos)';
            const statusClass = currentMeetingState.isActive ? 'bg-brand-success text-white' : 'bg-red-500 text-white';
            
            statusContainer.innerHTML = `
                <span class="text-xl font-bold text-gray-800">STATUS:</span>
                <span class="px-3 py-1 rounded-full ${statusClass} font-bold text-sm">${statusText}</span>
            `;
            
            startBtn.classList.toggle('hidden', currentMeetingState.isActive);
            endBtn.classList.toggle('hidden', !currentMeetingState.isActive);
            
            if (currentMeetingState.meetingId) {
                 const startDateFormatted = currentMeetingState.startDate ? formatDate(currentMeetingState.startDate) : 'N/A';
                 infoEl.textContent = `Dados exibidos: ${currentMeetingState.meetingName} (Início: ${startDateFormatted})`;
            } else {
                 infoEl.textContent = `Nenhuma reunião iniciada. Clique em "INICIAR NOVA REUNIÃO" para começar.`;
            }
        }
        
        // 6.4 Handlers dos Botões de Controle
        
        document.getElementById('start-meeting-btn').addEventListener('click', () => handleAdminMeetingControl('start'));
        document.getElementById('end-meeting-btn').addEventListener('click', () => handleAdminMeetingControl('end'));

        async function handleAdminMeetingControl(action) {
            try {
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(MEETING_STATE_DOC_REF);
                    const state = docSnapshot.exists() ? docSnapshot.data() : { isActive: false, meetingId: null, meetingName: 'Aguardando Início', startDate: null };

                    if (action === 'start') {
                        if (state.isActive) {
                            return; 
                        }
                        const now = new Date();
                        const newMeetingId = `M${now.getTime()}`;
                        const newMeetingName = `Reunião de ${now.toLocaleDateString('pt-BR')}`;
                        
                        const newState = {
                            isActive: true,
                            meetingId: newMeetingId,
                            meetingName: newMeetingName,
                            startDate: now.toISOString(), // Salva como ISO string
                        };
                        transaction.set(MEETING_STATE_DOC_REF, newState);
                        showStatusMessage(`Nova reunião (${newMeetingName}) iniciada!`, false); 
                        
                    } else if (action === 'end') {
                        if (!state.isActive) {
                            return; 
                        }

                        const newState = {
                            ...state,
                            isActive: false, 
                        };
                        transaction.set(MEETING_STATE_DOC_REF, newState);
                        showStatusMessage(`Reunião ${state.meetingName} finalizada. Registros suspensos.`, false); 
                    }
                });
            } catch (error) {
                console.error(`Erro ao ${action} a reunião:`, error);
                showStatusMessage(`Erro ao ${action} a reunião. Tente novamente. Verifique as Regras de Segurança.`, true);
            }
        }
        
        // 6.5 Download CSV (Filtrado pelo meetingId)
        document.getElementById('download-csv').addEventListener('click', () => {
            if (registrationsData.length === 0) {
                showStatusMessage("Nenhum dado para exportar.", true);
                return;
            }
            
            const meetingName = currentMeetingState.meetingName || 'dados_historicos';

            let csv = "ID,Nome,CPF,Instituicao,Setor,Representacao,Codigo_Validacao,Data_Reuniao,Timestamp\n";
            
            registrationsData.forEach(reg => {
                const dateObj = new Date(reg.timestamp); // Usa ISO string
                const timestampString = dateObj.toISOString();

                csv += `${reg.id},"${reg.name}","${reg.cpf}","${reg.institution}","${reg.sector}","${reg.representation}",${reg.validationCode},${reg.date},${timestampString}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `frequencia_${meetingName.replace(/\s/g, '_')}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showStatusMessage("CSV gerado com sucesso!", false);
            }
        });

        // 6.6 Download PDF (Filtrado pelo meetingId)
        document.getElementById('download-pdf').addEventListener('click', () => {
            if (registrationsData.length === 0) {
                showStatusMessage("Nenhum dado para exportar.", true);
                return;
            }

            // Certifique-se de que jspdf está carregado
            if (typeof window.jspdf === 'undefined') {
                 showStatusMessage("Erro: A biblioteca jspdf não está carregada.", true);
                 return;
            }
            
            const doc = new jspdf.jsPDF(); 
            const meetingName = currentMeetingState.meetingName || 'Registro de Frequência';
            const startDate = currentMeetingState.startDate ? formatDate(currentMeetingState.startDate) : 'N/A';
            
            // 2. ADICIONAR O CABEÇALHO PERSONALIZADO
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text("Comitê de Bacia Hidrográfica do Lago de Palmas", doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`${meetingName} | Início em ${startDate}`, doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' });

            // 3. PREPARAR DADOS PARA autoTable
            const headers = [["Nome", "Instituição/Órgão", "Setor", "Representação", "Cód. Validação"]];
            
            const body = registrationsData
                .sort((a, b) => a.name.localeCompare(b.name)) 
                .map(reg => {
                    return [
                        reg.name,
                        reg.institution,
                        reg.sector,
                        reg.representation,
                        reg.validationCode
                    ];
                });

            // 4. RENDERIZAR A TABELA USANDO autoTable
            if (typeof doc.autoTable === 'undefined') {
                showStatusMessage("Erro: jspdf-autotable não carregado. Verifique as dependências.", true);
                return;
            }

            doc.autoTable({
                startY: 40,
                head: headers,
                body: body,
                theme: 'striped', // Tema listrado
                styles: {
                    font: 'helvetica',
                    fontSize: 9, 
                    cellPadding: 1.5,
                    lineWidth: 0.1, 
                    lineColor: '#e0e0e0'
                },
                headStyles: {
                    fillColor: [23, 103, 129], // brand-primary: #176781
                    textColor: 255, 
                    fontStyle: 'bold',
                    fontSize: 10
                },
                columnStyles: {
                    0: { cellWidth: 50 }, 
                    1: { cellWidth: 50 }, 
                    2: { cellWidth: 30 }, 
                    3: { cellWidth: 30 }, 
                    4: { cellWidth: 30 }, 
                },
                didDrawPage: (data) => {
                    doc.setFontSize(8);
                    doc.text("Página " + data.pageNumber, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            let y = doc.autoTable.previous.finalY;

            // 5. ADICIONAR O LINK DE VALIDAÇÃO
            y += 20; 
            if (y > doc.internal.pageSize.height - 20) { 
                doc.addPage();
                y = 20;
            }
            
            doc.setFontSize(9);
            doc.setFont("helvetica", "italic");
            doc.setTextColor(0, 0, 0); 
            doc.text("Valide este e outros registros no portal oficial:", 10, y);
            y += 5;
            
            const siteLink = window.location.href; 
            doc.setTextColor(40, 58, 119); 
            doc.textWithLink(siteLink, 10, y, { url: siteLink });
            
            doc.setTextColor(0, 0, 0);

            doc.save(`frequencia_${meetingName.replace(/\s/g, '_')}.pdf`);
            showStatusMessage("PDF gerado com sucesso!", false);
        });

        // --- 7. Lógica de Validação ---
        
        document.getElementById('validation-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAuthReady) {
                showStatusMessage("Aguarde a inicialização do sistema...", true);
                return;
            }

            const code = document.getElementById('validation-code-input').value.trim();
            const resultEl = document.getElementById('validation-result');
            resultEl.classList.add('hidden');

            if (code.length !== 6) {
                showStatusMessage("O código deve ter 6 dígitos.", true);
                return;
            }

            try {
                // Define a Collection Reference dentro da função
                const registrationsRef = collection(db, REGISTRATIONS_COLLECTION_PATH); 
                
                // Busca o registro pelo código de validação.
                const q = query(registrationsRef, 
                                where("validationCode", "==", code));
                
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    resultEl.className = 'mt-6 p-6 rounded-xl bg-red-100 text-red-800 font-medium shadow-xl border-l-4 border-red-500';
                    resultEl.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-octagon"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                            <p class="font-bold text-lg">CÓDIGO NÃO ENCONTRADO!</p>
                        </div>
                        <p class="mt-2 text-sm">Nenhuma presença registrada com o código <span class="font-mono bg-red-200 px-1 rounded">${code}</span>.</p>
                    `;
                } else {
                    const data = querySnapshot.docs[0].data();
                    const isCurrent = data.meetingId === currentMeetingState.meetingId;
                    const meetingStatus = isCurrent 
                                            ? '<span class="text-brand-success"> (Reunião Atual)</span>' 
                                            : '<span class="text-brand-neutral"> (Reunião Histórica)</span>';

                    resultEl.className = 'mt-6 p-6 rounded-xl bg-brand-success/20 text-brand-primary font-medium shadow-xl border-l-4 border-brand-success';
                    
                    const registrationDate = data.timestamp ? new Date(data.timestamp).toLocaleString('pt-BR') : 'Data Indisponível';

                    resultEl.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle text-brand-success"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M9 11l3 3L22 4"/></svg>
                            <p class="font-bold text-lg text-brand-primary">PRESENÇA CONFIRMADA! ${meetingStatus}</p>
                        </div>
                        <div class="mt-3 space-y-1">
                            <p><strong>Nome:</strong> ${data.name}</p>
                            <p><strong>Instituição:</strong> ${data.institution}</p>
                            <p><strong>Setor:</strong> ${data.sector}</p>
                            <p><strong>Data da Reunião:</strong> <span class="font-semibold">${data.date}</span></p>
                        </div>
                        <p class="mt-3 text-xs italic text-gray-600">Este registro foi feito em ${registrationDate}.</p>
                    `;
                }
                resultEl.classList.remove('hidden');
            } catch (error) {
                console.error("Erro na validação do código:", error);
                showStatusMessage(`Erro ao validar o código: ${error.message || 'Tente novamente.'}`, true);
            }
        });
        
    </script>
</body>
</html>