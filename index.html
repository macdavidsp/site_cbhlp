<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Frequência e Quórum</title>
    
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Bibliotecas JS (Chart.js para gráficos, jspdf para PDF) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Configuração do Tailwind com a Paleta de Cores -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-primary': '#176781', // Dark Teal/Blue-Grey
                        'brand-accent': '#eac066', // Gold/Yellow (Highlight)
                        'brand-neutral': '#67686a', // Medium Grey
                        'brand-success': '#50c2ab', // Seafoam Green
                        'brand-light': '#7fb2c7',  // Soft Blue
                    },
                },
            },
        }
    </script>

    <!-- Estilos Customizados -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* --- ESTILO ATUALIZADO DO BOTÃO PRINCIPAL (REGISTRO/ADMIN) --- */
        .btn-primary {
            /* Layout alignment */
            @apply w-full flex items-center justify-center space-x-3 text-lg; 
            /* Enhanced Design: Gradient, strong shadow, larger text */
            @apply bg-gradient-to-r from-brand-primary to-brand-success text-white font-extrabold py-4 px-6 rounded-xl shadow-xl hover:shadow-2xl hover:from-brand-primary/90 hover:to-brand-success/90 transition duration-300 ease-in-out transform hover:scale-[1.01];
        }
        
        /* --- ESTILO DE INPUT APRIMORADO COM BORDAS MAIS CLARAS E DISCRETAS --- */
        .input-field {
            /* Border verde (#4ac0a7) e foco aprimorado */
            @apply w-full px-4 py-3 border border-[#4ac0a7] rounded-lg focus:outline-none focus:ring-4 focus:ring-brand-accent/30 focus:border-brand-primary transition duration-200 shadow-sm hover:shadow-md text-base;
        }

        /* Ajuste específico para dropdowns para garantir tamanho de fonte base e remover appearance-none */
        .input-field.select-field {
            @apply text-base; 
        }
        
        /* --- ESTILO DO CARD DE CONTEÚDO (O cartão principal branco) --- */
        .container-card {
            /* Adicionado um fundo suave para contraste e borda mais nítida */
            @apply p-6 md:p-10 bg-white shadow-2xl rounded-3xl max-w-4xl w-full mx-auto my-8 border border-brand-light/50;
        }
        
        /* --- ESTILO DO CARD DE MENU --- */
        .menu-card-btn {
            /* Hover mais distinto */
            @apply flex flex-col items-center justify-center p-6 bg-white border-2 border-brand-light rounded-2xl shadow-lg hover:shadow-xl hover:border-brand-accent text-center cursor-pointer transition duration-300 transform hover:scale-[1.03];
        }

        /* Título de Seção */
        .section-title {
            /* Título com a cor de destaque */
            @apply text-3xl font-extrabold mb-8 text-gray-800 border-b-4 border-brand-accent/50 pb-2 text-center;
        }

        /* Estilo para Tabela de Admin */
        .admin-table tbody tr:nth-child(odd) {
            background-color: #f9fafb; /* Lighter background for odd rows */
        }
        .admin-table tbody tr:hover {
            background-color: #f3f4f6; /* Subtle hover effect */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="app" class="flex flex-col min-h-screen">
        
        <!-- Mensagem de Status (Feedback) -->
        <div id="status-message" class="fixed top-4 right-4 p-4 rounded-xl shadow-2xl text-white font-medium transition-opacity duration-300 opacity-0 z-50 pointer-events-none" style="min-width: 300px;"></div>

        <!-- Cabeçalho (Botão para voltar ao Menu Principal) -->
        <header id="main-header" class="bg-white py-8 shadow-md mb-8 cursor-pointer hover:shadow-lg transition duration-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                
                <img 
                    src="logo.png" 
                    alt="Logo da Reunião" 
                    class="mx-auto h-32 sm:h-40 object-contain" 
                    onerror="this.onerror=null;this.src='https://placehold.co/200x72/176781/ffffff?text=LOGO'"
                >
                <h1 class="mt-4 text-4xl md:text-5xl font-extrabold text-gray-900 tracking-tight">
                    <span class="text-brand-primary">Sistema de Gestão On-line</span> de Reuniões
                </h1>
                <p class="mt-2 text-xl text-gray-500">
                    Clique aqui para voltar ao Menu Principal.
                </p>
            </div>
        </header>

        <main class="flex-grow p-4 sm:p-6 lg:p-8">

            <!-- 1. Menu Principal -->
            <section id="main-cards-view" class="view-section container-card">
                <h2 class="section-title text-brand-primary">Selecione a Ação Desejada</h2>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    
                    <button class="menu-card-btn" data-target="registro">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus text-brand-primary mb-3"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
                        <span class="text-xl font-semibold text-gray-800">Registro</span>
                        <span class="text-sm text-brand-neutral">Marcar Presença</span>
                    </button>

                    <button class="menu-card-btn" data-target="quorum">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pie-chart text-brand-success mb-3"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                        <span class="text-xl font-semibold text-gray-800">Quórum</span>
                        <span class="text-sm text-brand-neutral">Ver Status</span>
                    </button>

                    <button class="menu-card-btn" data-target="validacao">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-key-round text-brand-accent mb-3"><path d="M2 18L5 21L12 14L9 11L2 18Z"/><path d="M15 10L18 7L21 4"/><path d="M12 14L15 11"/><path d="M18 7L21 10"/></svg>
                        <span class="text-xl font-semibold text-gray-800">Validação</span>
                        <span class="text-sm text-brand-neutral">Verificar Código</span>
                    </button>

                    <button class="menu-card-btn" data-target="admin-login">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lock text-brand-neutral mb-3"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        <span class="text-xl font-semibold text-gray-800">Admin</span>
                        <span class="text-sm text-brand-neutral">Acesso Restrito</span>
                    </button>
                </div>
            </section>

            <!-- 2. Formulário de Registro (PRESENÇA) -->
            <section id="registro" class="view-section container-card hidden">
                <h2 class="section-title text-brand-accent">Seus Dados de Presença</h2>
                
                <!-- ATUALIZADO: Fundo do formulário agora usa bg-brand-light/30 e shadow-lg -->
                <form id="registration-form" class="space-y-6 p-6 bg-brand-light/30 rounded-2xl shadow-lg">
                    
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                        <input type="text" id="name" required class="input-field" placeholder="Seu Nome">
                    </div>

                    <div>
                        <label for="cpf" class="block text-sm font-medium text-gray-700 mb-1">CPF (apenas números)</label>
                        <input type="text" id="cpf" required pattern="\d{11}" maxlength="11" title="CPF deve ter 11 dígitos numéricos." class="input-field" placeholder="Ex: 12345678900">
                    </div>

                    <div>
                        <label for="institution" class="block text-sm font-medium text-gray-700 mb-1">Instituição / Órgão</label>
                        <input type="text" id="institution" required class="input-field" placeholder="Nome da Instituição">
                    </div>

                    <!-- CORREÇÃO 2: Layout em coluna única (grid-cols-1) para Setor e Representação -->
                    <div class="grid grid-cols-1 gap-4"> 
                        <div>
                            <label for="sector" class="block text-sm font-medium text-gray-700 mb-1">Setor</label>
                            <select id="sector" required class="input-field select-field">
                                <option value="">Selecione o Setor</option>
                                <option value="Usuario">Usuário</option>
                                <option value="Poder Público">Poder Público</option>
                                <option value="Sociedade Civil">Sociedade Civil</option>
                            </select>
                        </div>
                        <div>
                            <label for="representation" class="block text-sm font-medium text-gray-700 mb-1">Representação</label>
                            <select id="representation" required class="input-field select-field">
                                <option value="">Selecione a Repr.</option>
                                <option value="Titular">Titular</option>
                                <option value="Suplente">Suplente</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="pt-4">
                        <button type="submit" class="btn-primary w-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M9 11l3 3L22 4"/></svg>
                            <span>Confirmar e Registrar Presença</span>
                        </button>
                    </div>
                </form>
            </section>

            <!-- 3. Quórum (GRÁFICOS) -->
            <section id="quorum" class="view-section container-card hidden">
                <h2 class="section-title text-brand-accent">Acompanhamento do Quórum</h2>
                <div class="mb-8 bg-brand-light/30 p-6 rounded-xl shadow-lg flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                    <p class="text-xl font-medium text-gray-700">Reunião de: <span id="current-date" class="text-brand-primary font-bold">--</span></p>
                    <p class="text-xl font-medium text-gray-700">Total de Presentes:</p>
                    <span id="total-presentes" class="text-brand-success font-extrabold text-4xl p-2 rounded-lg bg-white shadow-inner">0</span>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- ATUALIZADO: Fundo do card do gráfico -->
                    <div class="bg-brand-light/30 p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-semibold mb-3 text-brand-neutral border-b pb-2">Distribuição por Setor</h3>
                        <canvas id="sectorChart" class="w-full"></canvas>
                    </div>
                    <!-- ATUALIZADO: Fundo do card do gráfico -->
                    <div class="bg-brand-light/30 p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-semibold mb-3 text-brand-neutral border-b pb-2">Distribuição por Representação</h3>
                        <canvas id="representationChart" class="w-full"></canvas>
                    </div>
                </div>
            </section>

            <!-- 4. Login Admin -->
            <section id="admin-login" class="view-section container-card hidden max-w-md">
                <h2 class="section-title text-brand-accent">Acesso de Administrador</h2>
                <!-- ATUALIZADO: Fundo do formulário agora usa bg-brand-light/30 e shadow-lg -->
                <form id="admin-login-form" class="space-y-6 p-6 bg-brand-light/30 rounded-xl shadow-lg">
                    <div>
                        <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">Senha de Administrador</label>
                        <input type="password" id="admin-password" required class="input-field" placeholder="Digite a senha">
                    </div>
                    
                    <button type="submit" class="btn-primary w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-in"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
                        <span>Acessar Dashboard</span>
                    </button>
                    <p class="text-sm text-red-600 mt-2 text-center font-semibold" id="admin-login-error"></p>
                </form>
            </section>

            <!-- 5. Dashboard Admin -->
            <section id="admin-dashboard" class="view-section container-card hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-2 border-brand-accent/50">
                    <h2 class="text-3xl font-extrabold text-brand-primary mb-3 sm:mb-0">Registros Detalhados</h2>
                    <div class="flex space-x-3">
                        <button id="download-csv" class="btn-primary py-2 px-4 text-sm font-semibold hover:bg-brand-primary/90">Download CSV</button>
                        <button id="download-pdf" class="btn-primary py-2 px-4 text-sm font-semibold hover:bg-brand-primary/90">Download PDF</button>
                    </div>
                </div>

                <!-- ATUALIZADO: Fundo da tabela agora usa bg-brand-light/30 e shadow-lg -->
                <div class="overflow-x-auto bg-brand-light/30 rounded-xl shadow-lg p-4 border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200 admin-table">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider rounded-tl-lg">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Nome</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">CPF</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Setor</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Rep.</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Cód. Validação</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider rounded-tr-lg">Data</th>
                            </tr>
                        </thead>
                        <tbody id="admin-table-body" class="divide-y divide-gray-100">
                            <!-- Registros inseridos via JS -->
                        </tbody>
                    </table>
                    <p id="admin-loading-message" class="text-center py-4 text-gray-500">Carregando dados...</p>
                </div>
            </section>

            <!-- 6. Validação de Código -->
            <section id="validacao" class="view-section container-card hidden max-w-md">
                <h2 class="section-title text-brand-accent">Verificação de Validação</h2>
                <!-- ATUALIZADO: Fundo do formulário agora usa bg-brand-light/30 e shadow-lg -->
                <form id="validation-form" class="space-y-4 p-6 bg-brand-light/30 rounded-xl shadow-lg">
                    <div>
                        <label for="validation-code-input" class="block text-sm font-medium text-gray-700 mb-1">Código de Validação</label>
                        <input type="text" id="validation-code-input" required class="input-field text-xl text-center tracking-widest" maxlength="6" placeholder="______">
                    </div>
                    
                    <button type="submit" class="btn-primary w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-check"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 13 2 2 4-4"/></svg>
                        <span>Validar Código</span>
                    </button>
                </form>
                
                <div id="validation-result" class="mt-6 p-6 rounded-xl text-brand-primary font-medium hidden shadow-xl border-l-4 border-brand-accent">
                    <!-- Resultado da validação aparece aqui -->
                </div>
            </section>

        </main>
        
        <!-- Rodapé -->
        <footer class="bg-gray-800 text-white p-4 text-center text-sm mt-8">
            Sistema de Registro de Frequência | Desenvolvido com Firebase & Tailwind CSS
        </footer>
    </div>

    <!-- Script JavaScript (Módulo) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, runTransaction, doc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Configurações e Variáveis Globais (MANDATÓRIO) ---
        
        // Acesso às variáveis de ambiente do Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // CONFIGURAÇÃO DO FIREBASE FORNECIDA PELO USUÁRIO
        const firebaseConfig = {
            apiKey: "AIzaSyCqI7tdOwMNwUqnhNyZyPIMqD-sjCFFxPU",
            authDomain: "cbhlp-assinaturas.firebaseapp.com",
            projectId: "cbhlp-assinaturas",
            storageBucket: "cbhlp-assinaturas.firebasestorage.app",
            messagingSenderId: "817507030657",
            appId: "1:817507030657:web:c2a7d65850302ba5439f80"
        };
        
        // O token é fornecido pelo Canvas (ou é null se não estiver definido)
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Senha de Administrador Simples (MUDAR EM PRODUÇÃO!)
        const ADMIN_PASSWORD = "minhasenhasecreta123";

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Define o nível de log para debug no console
        setLogLevel('debug'); 

        let userId = null;
        let isAuthReady = false;
        let registrationsData = []; // Cache dos dados de registro

        // Referência à coleção pública de registros
        const REGISTRATIONS_COLLECTION = `artifacts/${appId}/public/data/meeting_registrations`;

        // --- Funções de Utilitário ---

        // Exibe mensagens de status na tela
        function showStatusMessage(message, isError = false) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = 'fixed top-4 right-4 p-4 rounded-xl shadow-2xl font-medium transition-opacity duration-300 z-50';
            
            if (isError) {
                statusEl.classList.add('bg-red-600', 'text-white');
            } else {
                statusEl.classList.add('bg-brand-success', 'text-white'); 
            }
            
            statusEl.classList.remove('opacity-0', 'pointer-events-none');
            statusEl.classList.add('opacity-100');

            setTimeout(() => {
                statusEl.classList.remove('opacity-100');
                statusEl.classList.add('opacity-0', 'pointer-events-none');
            }, 5000);
        }

        // Gera um código de validação de 6 dígitos
        function generateValidationCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Formata a data de hoje como YYYY-MM-DD
        function getTodayDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // --- 1. Lógica de Autenticação (Setup Inicial) ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Usuário autenticado:", userId);
            } else {
                try {
                    // Tenta o login com o token customizado
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        // Se não houver token, faz login anônimo
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Erro na autenticação inicial:", error);
                }
            }
            isAuthReady = true;
            // Inicia o listener do quórum se a view inicial for quorum ou admin-dashboard
            const currentView = Array.from(viewSections).find(v => !v.classList.contains('hidden'))?.id;
            if (currentView === 'quorum' || currentView === 'admin-dashboard') {
                setupQuorumListener();
            }
        });

        // --- 2. Controle de Navegação (SPA) ---
        const viewSections = document.querySelectorAll('.view-section');
        
        // Função para trocar a visualização
        function switchView(targetId) {
            viewSections.forEach(section => {
                section.classList.add('hidden');
            });
            const targetElement = document.getElementById(targetId);
            if(targetElement) {
                targetElement.classList.remove('hidden');
            }

            // Atualiza os listeners dependendo da seção
            if (targetId === 'quorum' && isAuthReady) {
                setupQuorumListener();
            } else if (targetId === 'admin-dashboard' && isAuthReady) {
                setupAdminListener();
            }
            
            // Certifica-se de que se não for a main-cards-view, ela está escondida
            if (targetId !== 'main-cards-view') {
                 document.getElementById('main-cards-view').classList.add('hidden');
            }
        }
        
        // Função unificada para lidar com cliques de navegação (Cards)
        function handleViewSwitch(requestedTarget) {
            let targetId = requestedTarget;
            
            // Lógica para o botão Admin
            if (requestedTarget === 'admin-login') {
                 if (!document.getElementById('admin-dashboard').classList.contains('hidden')) {
                     targetId = 'admin-dashboard'; // Se já estiver logado, vai direto para o dashboard
                 } else {
                     targetId = 'admin-login'; // Caso contrário, vai para o formulário de login
                 }
            }
            switchView(targetId);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Define a visualização inicial: main-cards-view
            switchView('main-cards-view'); 

            // Adiciona listener ao cabeçalho (logo/título) para voltar ao Menu Principal
            document.getElementById('main-header').addEventListener('click', () => {
                switchView('main-cards-view');
            });
            
            // Adiciona listeners aos botões da galeria (cards)
            document.addEventListener('click', (e) => {
                const card = e.target.closest('.menu-card-btn');
                if (card) {
                    handleViewSwitch(card.dataset.target);
                }
            });
        });
        
        // --- 3. Lógica do Formulário de Registro (1ª Função) ---
        
        document.getElementById('registration-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthReady) {
                showStatusMessage("Aguarde a inicialização do sistema...", true);
                return;
            }

            const name = document.getElementById('name').value.trim();
            const cpf = document.getElementById('cpf').value.trim();
            const institution = document.getElementById('institution').value.trim();
            const sector = document.getElementById('sector').value;
            const representation = document.getElementById('representation').value;
            const todayDate = getTodayDate();
            
            const validationCode = generateValidationCode();
            
            try {
                // 1. Verificar Duplicidade (CPF no mesmo dia)
                const q = query(collection(db, REGISTRATIONS_COLLECTION), 
                                where("cpf", "==", cpf), 
                                where("date", "==", todayDate));
                
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    showStatusMessage(`Seu CPF já está registrado para a reunião de hoje (${todayDate}).`, true);
                    return;
                }
                
                // 2. Registrar Transação (para minimizar conflitos simultâneos)
                await runTransaction(db, async (transaction) => {
                    // Refaz a verificação dentro da transação (melhor prática para garantir atomicidade)
                    const reCheck = await getDocs(q);
                    if (!reCheck.empty) {
                        throw "Duplicidade detectada por transação."; // Lança erro para abortar a transação
                    }
                    
                    const newRegistration = {
                        name,
                        cpf,
                        institution,
                        sector,
                        representation,
                        date: todayDate,
                        validationCode,
                        timestamp: new Date()
                    };
                    
                    // Adiciona o novo documento
                    const docRef = doc(collection(db, REGISTRATIONS_COLLECTION));
                    transaction.set(docRef, newRegistration);
                    
                    showStatusMessage(`Presença registrada com sucesso! Código de Validação: ${validationCode}`, false);
                    document.getElementById('registration-form').reset(); // Limpa o formulário
                    
                    // Após o registro, retorna para a tela de Cards
                    switchView('main-cards-view'); 
                });

            } catch (error) {
                if (error === "Duplicidade detectada por transação.") {
                    showStatusMessage(`Duplicidade: Seu CPF já foi registrado para a reunião de hoje.`, true);
                } else {
                    console.error("Erro ao registrar a frequência:", error);
                    showStatusMessage(`Erro ao registrar: ${error.message || 'Tente novamente.'}`, true);
                }
            }
        });

        // --- 4. Lógica do Gráfico de Quórum (2ª Função) ---
        
        let sectorChart = null;
        let representationChart = null;
        
        // Cores do gráfico baseadas na nova paleta
        const chartColors = ['#176781', '#eac066', '#50c2ab', '#7fb2c7', '#67686a'];

        function updateQuorumCharts(data) {
            const today = getTodayDate();
            document.getElementById('current-date').textContent = today;
            
            // Filtra os dados apenas para a reunião de hoje
            const todayData = data.filter(r => r.date === today);
            
            document.getElementById('total-presentes').textContent = todayData.length;

            // Agrega dados por Setor
            const sectorCounts = todayData.reduce((acc, curr) => {
                acc[curr.sector] = (acc[curr.sector] || 0) + 1;
                return acc;
            }, {});
            
            // Agrega dados por Representação
            const representationCounts = todayData.reduce((acc, curr) => {
                acc[curr.representation] = (acc[curr.representation] || 0) + 1;
                return acc;
            }, {});

            const sectorLabels = Object.keys(sectorCounts);
            const sectorValues = Object.values(sectorCounts);
            
            const repLabels = Object.keys(representationCounts);
            const repValues = Object.values(representationCounts);
            
            // Atualiza Gráfico de Setores
            if (sectorChart) sectorChart.destroy();
            const sectorCtx = document.getElementById('sectorChart').getContext('2d');
            // Chart é uma variável global
            sectorChart = new Chart(sectorCtx, {
                type: 'pie',
                data: {
                    labels: sectorLabels,
                    datasets: [{
                        label: 'Presença por Setor',
                        data: sectorValues,
                        backgroundColor: sectorLabels.map((_, i) => chartColors[i % chartColors.length]),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    }
                }
            });
            
            // Atualiza Gráfico de Representação
            if (representationChart) representationChart.destroy();
            const repCtx = document.getElementById('representationChart').getContext('2d');
            // Chart é uma variável global
            representationChart = new Chart(repCtx, {
                type: 'doughnut',
                data: {
                    labels: repLabels,
                    datasets: [{
                        label: 'Presença por Representação',
                        data: repValues,
                        backgroundColor: repLabels.map((_, i) => chartColors[i % chartColors.length]),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    }
                }
            });
        }
        
        // Listener em Tempo Real (onSnapshot) para Quórum
        function setupQuorumListener() {
            if (!isAuthReady) return;
            
            const q = query(collection(db, REGISTRATIONS_COLLECTION));
            
            // onSnapshot retorna uma função de "unsubscribe". Para simplificar o SPA de arquivo único, 
            // não estamos gerenciando o unsubscribe ativamente, mas o novo onSnapshot substituirá o antigo.
            
            onSnapshot(q, (snapshot) => {
                registrationsData = [];
                snapshot.forEach((doc) => {
                    registrationsData.push({ id: doc.id, ...doc.data() });
                });
                console.log("Dados de registro atualizados (onSnapshot).");
                updateQuorumCharts(registrationsData);
                // Se o admin estiver logado, atualiza a tabela também
                if (!document.getElementById('admin-dashboard').classList.contains('hidden')) {
                    renderAdminTable(registrationsData);
                }
            }, (error) => {
                console.error("Erro ao ouvir atualizações do Quórum:", error);
                showStatusMessage("Erro ao carregar dados do quórum.", true);
            });
        }


        // --- 5. Lógica da Área Administrativa (3ª Função) ---

        // 5.1 Login
        document.getElementById('admin-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('admin-login-error');
            
            if (password === ADMIN_PASSWORD) {
                errorEl.textContent = "";
                // Muda a visualização
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                
                // Se ainda não estiver escutando, inicia o listener
                if (registrationsData.length === 0) {
                     setupQuorumListener();
                } else {
                     renderAdminTable(registrationsData);
                }
            } else {
                errorEl.textContent = "Senha incorreta. Tente novamente.";
                showStatusMessage("Senha de Admin incorreta.", true);
            }
        });

        // 5.2 Renderização da Tabela
        function renderAdminTable(data) {
            const tableBody = document.getElementById('admin-table-body');
            const loadingMsg = document.getElementById('admin-loading-message');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                loadingMsg.textContent = "Nenhum registro encontrado.";
                loadingMsg.classList.remove('hidden');
                return;
            }
            loadingMsg.classList.add('hidden');

            // Ordena por data/hora mais recente primeiro
            // Nota: O timestamp pode vir como um objeto Timestamp do Firebase ou como um objeto Date/string
            data.sort((a, b) => {
                const dateA = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                const dateB = b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                return dateB - dateA;
            });

            data.forEach(reg => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-100 transition duration-150';
                
                const dateObj = reg.timestamp.toDate ? reg.timestamp.toDate() : new Date(reg.timestamp);
                const timeString = dateObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                row.insertCell().textContent = reg.id.substring(0, 4) + '...'; // ID abreviado
                row.insertCell().textContent = reg.name;
                row.insertCell().textContent = reg.cpf;
                row.insertCell().textContent = reg.sector;
                row.insertCell().textContent = reg.representation;
                row.insertCell().textContent = reg.validationCode;
                row.insertCell().textContent = `${reg.date} (${timeString})`;
            });
        }
        
        function setupAdminListener() {
            // Reusa o listener do Quórum (setupQuorumListener) pois ele já carrega os dados em tempo real para 'registrationsData'
            // A função setupQuorumListener() será responsável por chamar renderAdminTable quando os dados mudarem.
            if (registrationsData.length === 0) {
                // Se não tiver dados, o listener deve ser iniciado
                setupQuorumListener();
            } else {
                // Se já tiver dados, apenas renderiza
                renderAdminTable(registrationsData);
            }
        }

        // 5.3 Download CSV
        document.getElementById('download-csv').addEventListener('click', () => {
            if (registrationsData.length === 0) {
                showStatusMessage("Nenhum dado para exportar.", true);
                return;
            }

            const today = getTodayDate();
            
            let csv = "ID,Nome,CPF,Instituicao,Setor,Representacao,Codigo_Validacao,Data_Reuniao,Timestamp\n";
            
            registrationsData.forEach(reg => {
                const dateObj = reg.timestamp.toDate ? reg.timestamp.toDate() : new Date(reg.timestamp);
                const timestampString = dateObj.toISOString();

                csv += `${reg.id},"${reg.name}","${reg.cpf}","${reg.institution}","${reg.sector}","${reg.representation}",${reg.validationCode},${reg.date},${timestampString}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `frequencia_reuniao_${today}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showStatusMessage("CSV gerado com sucesso!", false);
            }
        });

        // 5.4 Download PDF (Usando jsPDF)
        document.getElementById('download-pdf').addEventListener('click', () => {
            if (registrationsData.length === 0) {
                showStatusMessage("Nenhum dado para exportar.", true);
                return;
            }

            const today = getTodayDate();
            
            // Acessa o construtor jsPDF através do objeto global 'jspdf'
            const doc = new jspdf.jsPDF(); 
            doc.setFontSize(18);
            doc.text(`Relatório de Frequência - ${today}`, 10, 10);
            
            const headers = [["ID (Abrev)", "Nome", "CPF", "Setor", "Rep.", "Código", "Data/Hora"]];
            
            const body = registrationsData.map(reg => {
                const dateObj = reg.timestamp.toDate ? reg.timestamp.toDate() : new Date(reg.timestamp);
                const timeString = dateObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                return [
                    reg.id.substring(0, 4) + '...',
                    reg.name,
                    reg.cpf,
                    reg.sector,
                    reg.representation,
                    reg.validationCode,
                    `${reg.date} ${timeString}`
                ];
            });

            // Renderiza cabeçalho e corpo da tabela
            let y = 20;
            doc.setFontSize(10);
            const tableData = headers.concat(body);
            
            // Renderiza cabeçalho
            doc.setFont("helvetica", "bold");
            let x = 10;
            const columnWidths = [15, 45, 25, 25, 20, 20, 30]; // Larguras aproximadas para A4

            headers[0].forEach((header, index) => {
                doc.text(header, x, y);
                x += columnWidths[index];
            });
            y += 5;
            doc.line(10, y, 200, y); // Linha separadora
            y += 5;

            // Renderiza corpo
            doc.setFont("helvetica", "normal");
            tableData.slice(1).forEach((row) => {
                x = 10;
                row.forEach((cell, index) => {
                    doc.text(cell.toString(), x, y, { maxWidth: columnWidths[index] - 2 });
                    x += columnWidths[index];
                });
                y += 7;
                // Adiciona nova página se necessário
                if (y > 280) {
                    doc.addPage();
                    y = 10;
                }
            });

            doc.save(`frequencia_reuniao_${today}.pdf`);
            showStatusMessage("PDF gerado com sucesso!", false);
        });

        // --- 6. Lógica de Validação (4ª Função) ---
        
        document.getElementById('validation-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAuthReady) {
                showStatusMessage("Aguarde a inicialização do sistema...", true);
                return;
            }

            const code = document.getElementById('validation-code-input').value.trim();
            const resultEl = document.getElementById('validation-result');
            resultEl.classList.add('hidden');

            if (code.length !== 6) {
                showStatusMessage("O código deve ter 6 dígitos.", true);
                return;
            }

            try {
                // Busca o registro pelo código de validação
                const q = query(collection(db, REGISTRATIONS_COLLECTION), 
                                where("validationCode", "==", code));
                
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    // Estilo para Erro/Não Encontrado
                    resultEl.className = 'mt-6 p-6 rounded-xl bg-red-100 text-red-800 font-medium shadow-xl border-l-4 border-red-500';
                    resultEl.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-octagon"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                            <p class="font-bold text-lg">CÓDIGO NÃO ENCONTRADO!</p>
                        </div>
                        <p class="mt-2 text-sm">Nenhuma presença registrada com o código <span class="font-mono bg-red-200 px-1 rounded">${code}</span>.</p>
                    `;
                } else {
                    const data = querySnapshot.docs[0].data();
                    // Estilo para Sucesso (com cores da paleta)
                    resultEl.className = 'mt-6 p-6 rounded-xl bg-brand-success/20 text-brand-primary font-medium shadow-xl border-l-4 border-brand-success';
                    resultEl.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle text-brand-success"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M9 11l3 3L22 4"/></svg>
                            <p class="font-bold text-lg text-brand-primary">PRESENÇA CONFIRMADA!</p>
                        </div>
                        <div class="mt-3 space-y-1">
                            <p><strong>Nome:</strong> ${data.name}</p>
                            <p><strong>Instituição:</strong> ${data.institution}</p>
                            <p><strong>Setor:</strong> ${data.sector}</p>
                            <p><strong>Data da Reunião:</strong> <span class="font-semibold">${data.date}</span></p>
                        </div>
                        <p class="mt-3 text-xs italic text-gray-600">Este registro foi feito em ${data.timestamp.toDate().toLocaleString('pt-BR')}.</p>
                    `;
                }
                resultEl.classList.remove('hidden');
            } catch (error) {
                console.error("Erro na validação do código:", error);
                showStatusMessage(`Erro ao validar o código: ${error.message || 'Tente novamente.'}`, true);
            }
        });
        
    </script>
</body>
</html>