<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Frequência e Quórum</title>
    
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Bibliotecas JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- NOVO: Adiciona a biblioteca jspdf-autotable para tabelas formatadas no PDF -->
    <script src="https://unpkg.com/jspdf-autotable@3.5.21/dist/jspdf.plugin.autotable.js"></script>
    
    <!-- Configuração do Tailwind com a Paleta de Cores -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-primary': '#176781', // Dark Teal/Blue-Grey
                        'brand-accent': '#eac066', // Gold/Yellow (Highlight)
                        'brand-neutral': '#67686a', // Medium Grey
                        'brand-success': '#50c2ab', // Seafoam Green
                        'brand-light': '#7fb2c7',  // Soft Blue
                        'brand-danger': '#dc2626', // Red for actions like reset
                    },
                },
            },
        }
    </script>

    <!-- Estilos Customizados -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* --- ESTILO ATUALIZADO DO BOTÃO PRINCIPAL (REGISTRO/ADMIN) --- */
        .btn-primary {
            /* Layout alignment */
            @apply w-full flex items-center justify-center space-x-3 text-lg; 
            /* Enhanced Design: Gradient, strong shadow, larger text */
            @apply bg-gradient-to-r from-brand-primary to-brand-success text-white font-extrabold py-4 px-6 rounded-xl shadow-xl hover:shadow-2xl hover:from-brand-primary/90 hover:to-brand-success/90 transition duration-300 ease-in-out transform hover:scale-[1.01];
        }

        .btn-danger {
            @apply bg-brand-danger text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 transition duration-150;
        }
        
        /* --- ESTILO DE INPUT APRIMORADO COM BORDAS MAIS CLARAS E DISCRETAS --- */
        .input-field {
            /* Border verde (#4ac0a7) e foco aprimorado */
            @apply w-full px-4 py-3 border border-[#4ac0a7] rounded-lg focus:outline-none focus:ring-4 focus:ring-brand-accent/30 focus:border-brand-primary transition duration-200 shadow-sm hover:shadow-md text-base;
        }

        /* Ajuste específico para dropdowns para garantir tamanho de fonte base e remover appearance-none */
        .input-field.select-field {
            @apply text-base; 
        }
        
        /* --- ESTILO DO CARD DE CONTEÚDO (O cartão principal branco) --- */
        .container-card {
            /* Adicionado um fundo suave para contraste e borda mais nítida */
            @apply p-6 md:p-10 bg-white shadow-2xl rounded-3xl max-w-4xl w-full mx-auto my-8 border border-brand-light/50;
        }
        
        /* --- ESTILO DO CARD DE MENU --- */
        .menu-card-btn {
            /* Hover mais distinto */
            @apply flex flex-col items-center justify-center p-6 bg-white border-2 border-brand-light rounded-2xl shadow-lg hover:shadow-xl hover:border-brand-accent text-center cursor-pointer transition duration-300 transform hover:scale-[1.03];
        }

        /* Título de Seção */
        .section-title {
            /* Título com a cor de destaque */
            @apply text-3xl font-extrabold mb-8 text-gray-800 border-b-4 border-brand-accent/50 pb-2 text-center;
        }

        /* Estilo para Tabela de Admin */
        .admin-table tbody tr:nth-child(odd) {
            background-color: #f9fafb; /* Lighter background for odd rows */
        }
        .admin-table tbody tr:hover {
            background-color: #f3f4f6; /* Subtle hover effect */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="app" class="flex flex-col min-h-screen">
        
        <!-- Mensagem de Status (Feedback) -->
        <div id="status-message" class="fixed top-4 right-4 p-4 rounded-xl shadow-2xl text-white font-medium transition-opacity duration-300 opacity-0 z-50 pointer-events-none" style="min-width: 300px;"></div>

        <!-- Cabeçalho (Botão para voltar ao Menu Principal) -->
        <header id="main-header" class="bg-white py-8 shadow-md mb-8 cursor-pointer hover:shadow-lg transition duration-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                
                <img 
                    src="logo.png" 
                    alt="Logo da Reunião" 
                    class="mx-auto h-32 sm:h-40 object-contain" 
                    onerror="this.onerror=null;this.src='https://placehold.co/200x72/176781/ffffff?text=LOGO'"
                >
                <h1 class="mt-4 text-4xl md:text-5xl font-extrabold text-gray-900 tracking-tight">
                    <span class="text-brand-primary">Sistema de Gestão On-line</span> de Reuniões
                </h1>
                <p class="mt-2 text-xl text-gray-500">
                    Clique aqui para voltar ao Menu Principal.
                </p>
            </div>
        </header>

        <main class="flex-grow p-4 sm:p-6 lg:p-8">

            <!-- 1. Menu Principal -->
            <section id="main-cards-view" class="view-section container-card">
                <h2 class="section-title text-brand-primary">Selecione a Ação Desejada</h2>
                
                <!-- NOVO: Indicador de status da reunião -->
                <div id="meeting-status-indicator" class="text-center mb-6 p-3 rounded-lg shadow-inner font-semibold text-lg">
                    <!-- Mensagem dinâmica inserida via JS -->
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    
                    <button class="menu-card-btn" data-target="registro" id="btn-registro">
                        <div class="flex justify-center w-full mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus text-brand-primary"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
                        </div>
                        <span class="text-xl font-semibold text-gray-800">Registro</span>
                        <span class="text-sm text-brand-neutral">Marcar Presença</span>
                    </button>

                    <button class="menu-card-btn" data-target="quorum">
                        <div class="flex justify-center w-full mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pie-chart text-brand-success"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                        </div>
                        <span class="text-xl font-semibold text-gray-800">Quórum</span>
                        <span class="text-sm text-brand-neutral">Ver Status</span>
                    </button>

                    <button class="menu-card-btn" data-target="validacao">
                        <div class="flex justify-center w-full mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-key-round text-brand-accent"><path d="M2 18L5 21L12 14L9 11L2 18Z"/><path d="M15 10L18 7L21 4"/><path d="M12 14L15 11"/><path d="M18 7L21 10"/></svg>
                        </div>
                        <span class="text-xl font-semibold text-gray-800">Validação</span>
                        <span class="text-sm text-brand-neutral">Verificar Código</span>
                    </button>

                    <button class="menu-card-btn" data-target="admin-login">
                        <div class="flex justify-center w-full mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lock text-brand-neutral"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        </div>
                        <span class="text-xl font-semibold text-gray-800">Admin</span>
                        <span class="text-sm text-brand-neutral">Acesso Restrito</span>
                    </button>
                </div>
            </section>

            <!-- 2. Formulário de Registro (PRESENÇA) -->
            <section id="registro" class="view-section container-card hidden">
                <h2 class="section-title text-brand-accent">Seus Dados de Presença</h2>
                
                <div id="registro-alert" class="p-4 mb-4 rounded-lg text-center font-medium bg-red-100 text-red-700 hidden">
                    <p>O registro de presença está fechado. Por favor, aguarde o Administrador iniciar a reunião.</p>
                </div>

                <!-- ATUALIZADO: Fundo do formulário agora usa bg-brand-light/30 e shadow-lg -->
                <form id="registration-form" class="space-y-6 p-6 bg-brand-light/30 rounded-2xl shadow-lg">
                    
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                        <input type="text" id="name" required class="input-field" placeholder="Seu Nome">
                    </div>

                    <div>
                        <label for="cpf" class="block text-sm font-medium text-gray-700 mb-1">CPF (apenas números)</label>
                        <input type="text" id="cpf" required pattern="\d{11}" maxlength="11" title="CPF deve ter 11 dígitos numéricos." class="input-field" placeholder="Ex: 12345678900">
                    </div>

                    <div>
                        <label for="institution" class="block text-sm font-medium text-gray-700 mb-1">Instituição / Órgão</label>
                        <input type="text" id="institution" required class="input-field" placeholder="Nome da Instituição">
                    </div>

                    <!-- CORREÇÃO 2: Layout em coluna única (grid-cols-1) para Setor e Representação -->
                    <div class="grid grid-cols-1 gap-4"> 
                        <div>
                            <label for="sector" class="block text-sm font-medium text-gray-700 mb-1">Setor</label>
                            <select id="sector" required class="input-field select-field">
                                <option value="">Selecione o Setor</option>
                                <option value="Usuario">Usuário</option>
                                <option value="Poder Público">Poder Público</option>
                                <option value="Sociedade Civil">Sociedade Civil</option>
                            </select>
                        </div>
                        <div>
                            <label for="representation" class="block text-sm font-medium text-gray-700 mb-1">Representação</label>
                            <select id="representation" required class="input-field select-field">
                                <option value="">Selecione a Repr.</option>
                                <option value="Titular">Titular</option>
                                <option value="Suplente">Suplente</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="pt-4">
                        <button type="submit" class="btn-primary w-full" id="btn-submit-registro">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M9 11l3 3L22 4"/></svg>
                            <span>Confirmar e Registrar Presença</span>
                        </button>
                    </div>
                </form>
            </section>

            <!-- 3. Quórum (GRÁFICOS) -->
            <section id="quorum" class="view-section container-card hidden">
                <h2 class="section-title text-brand-accent">Acompanhamento do Quórum</h2>
                <div class="mb-8 bg-brand-light/30 p-6 rounded-xl shadow-lg flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                    <p class="text-xl font-medium text-gray-700">Reunião de: <span id="current-date" class="text-brand-primary font-bold">--</span></p>
                    <p class="text-xl font-medium text-gray-700">Total de Presentes:</p>
                    <span id="total-presentes" class="text-brand-success font-extrabold text-4xl p-2 rounded-lg bg-white shadow-inner">0</span>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- ATUALIZADO: Fundo do card do gráfico -->
                    <div class="bg-brand-light/30 p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-semibold mb-3 text-brand-neutral border-b pb-2">Distribuição por Setor</h3>
                        <canvas id="sectorChart" class="w-full"></canvas>
                    </div>
                    <!-- ATUALIZADO: Fundo do card do gráfico -->
                    <div class="bg-brand-light/30 p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-semibold mb-3 text-brand-neutral border-b pb-2">Distribuição por Representação</h3>
                        <canvas id="representationChart" class="w-full"></canvas>
                    </div>
                </div>
            </section>

            <!-- 4. Login Admin -->
            <section id="admin-login" class="view-section container-card hidden max-w-md">
                <h2 class="section-title text-brand-accent">Acesso de Administrador</h2>
                <!-- ATUALIZADO: Fundo do formulário agora usa bg-brand-light/30 e shadow-lg -->
                <form id="admin-login-form" class="space-y-6 p-6 bg-brand-light/30 rounded-xl shadow-lg">
                    <div>
                        <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">Senha de Administrador</label>
                        <input type="password" id="admin-password" required class="input-field" placeholder="Digite a senha">
                    </div>
                    
                    <button type="submit" class="btn-primary w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-in"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
                        <span>Acessar Dashboard</span>
                    </button>
                    <p class="text-sm text-red-600 mt-2 text-center font-semibold" id="admin-login-error"></p>
                </form>
            </section>

            <!-- 5. Dashboard Admin -->
            <section id="admin-dashboard" class="view-section container-card hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-2 border-brand-accent/50">
                    <h2 class="text-3xl font-extrabold text-brand-primary mb-3 sm:mb-0">Registros Detalhados</h2>
                    <div class="flex space-x-3">
                        <button id="download-csv" class="btn-primary py-2 px-4 text-sm font-semibold hover:bg-brand-primary/90">Download CSV</button>
                        <button id="download-pdf" class="btn-primary py-2 px-4 text-sm font-semibold hover:bg-brand-primary/90">Download PDF</button>
                    </div>
                </div>

                <!-- NOVO: CONTROLES DE ADMINISTRAÇÃO DA REUNIÃO -->
                <div class="bg-gray-100 p-6 rounded-xl shadow-inner mb-8 border border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Controle da Reunião</h3>
                    
                    <div class="mb-4 p-3 rounded-lg text-center font-semibold text-lg" id="admin-meeting-status">
                        <!-- Status atual da reunião -->
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button id="start-meeting" class="bg-brand-success text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-150">INICIAR NOVA REUNIÃO</button>
                        <button id="end-meeting" class="bg-brand-neutral text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-gray-700 transition duration-150">FINALIZAR REUNIÃO</button>
                        
                        <!-- NOVO BOTÃO: RESETAR QUÓRUM DE HOJE -->
                        <button id="reset-quorum-today" class="btn-danger py-3 px-4">RESETAR QUÓRUM DE HOJE</button>
                    </div>
                    <p class="mt-4 text-sm text-gray-500">
                        O botão "Resetar Quórum de Hoje" **apaga** todos os registros de presença da reunião que está ativa no momento.
                    </p>
                </div>
                
                <!-- ATUALIZADO: Fundo da tabela agora usa bg-brand-light/30 e shadow-lg -->
                <div class="overflow-x-auto bg-brand-light/30 rounded-xl shadow-lg p-4 border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Tabela de Presenças da Reunião Ativa (<span id="admin-meeting-date">--</span>)</h3>
                    <table class="min-w-full divide-y divide-gray-200 admin-table">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider rounded-tl-lg">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Nome</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">CPF</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Setor</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Rep.</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Cód. Validação</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider rounded-tr-lg">Data</th>
                            </tr>
                        </thead>
                        <tbody id="admin-table-body" class="divide-y divide-gray-100">
                            <!-- Registros inseridos via JS -->
                        </tbody>
                    </table>
                    <p id="admin-loading-message" class="text-center py-4 text-gray-500">Carregando dados...</p>
                </div>
            </section>

            <!-- 6. Validação de Código -->
            <section id="validacao" class="view-section container-card hidden max-w-md">
                <h2 class="section-title text-brand-accent">Verificação de Validação</h2>
                <!-- ATUALIZADO: Fundo do formulário agora usa bg-brand-light/30 e shadow-lg -->
                <form id="validation-form" class="space-y-4 p-6 bg-brand-light/30 rounded-xl shadow-lg">
                    <div>
                        <label for="validation-code-input" class="block text-sm font-medium text-gray-700 mb-1">Código de Validação</label>
                        <input type="text" id="validation-code-input" required class="input-field text-xl text-center tracking-widest" maxlength="6" placeholder="______">
                    </div>
                    
                    <button type="submit" class="btn-primary w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-check"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 13 2 2 4-4"/></svg>
                        <span>Validar Código</span>
                    </button>
                </form>
                
                <div id="validation-result" class="mt-6 p-6 rounded-xl text-brand-primary font-medium hidden shadow-xl border-l-4 border-brand-accent">
                    <!-- Resultado da validação aparece aqui -->
                </div>
            </section>
            
            <!-- NOVO: Modal de Confirmação (Substitui alert/confirm) -->
            <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100] hidden" role="dialog" aria-modal="true">
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
                    <h3 class="text-xl font-bold mb-4 text-brand-danger border-b pb-2">Confirmação Necessária</h3>
                    <p class="mb-6 text-gray-700" id="modal-text">Você tem certeza que deseja executar esta ação?</p>
                    <div class="flex justify-end space-x-3">
                        <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                        <button id="modal-confirm" class="px-4 py-2 bg-brand-danger text-white rounded-lg hover:bg-red-700 transition">Confirmar</button>
                    </div>
                </div>
            </div>

        </main>
        
        <!-- Rodapé -->
        <footer class="bg-gray-800 text-white p-4 text-center text-sm mt-8">
            Sistema de Registro de Frequência | Desenvolvido com Firebase & Tailwind CSS
        </footer>
    </div>

    <!-- Script JavaScript (Módulo) -->
    <script type="module">
        // Importações do Firebase (Protocolo HTTPS corrigido)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // ATUALIZADO: Adicionado deleteDoc e getDoc
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, runTransaction, doc, setDoc, deleteDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Configurações e Variáveis Globais (MANDATÓRIO) ---
        
        // Acesso às variáveis de ambiente do Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // CONFIGURAÇÃO DO FIREBASE FORNECIDA PELO USUÁRIO
        const firebaseConfig = {
            apiKey: "AIzaSyCqI7tdOwMNwUqnhNyZyPIMqD-sjCFFxPU",
            authDomain: "cbhlp-assinaturas.firebaseapp.com",
            projectId: "cbhlp-assinaturas",
            storageBucket: "cbhlp-assinaturas.firebasestorage.app",
            messagingSenderId: "817507030657",
            appId: "1:817507030657:web:c2a7d65850302ba5439f80"
        };
        
        // O token é fornecido pelo Canvas (ou é null se não estiver definido)
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Senha de Administrador Simples (MUDAR EM PRODUÇÃO!)
        const ADMIN_PASSWORD = "minhasenhasecreta123";

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Define o nível de log para debug no console
        setLogLevel('debug'); 

        let userId = null;
        let isAuthReady = false;
        let registrationsData = []; // Cache dos dados de registro

        // NOVO: Estado da reunião (global)
        let meetingState = {
            isActive: false,
            meetingId: null, // Será a data da reunião em YYYY-MM-DD
            meetingName: "Nenhuma Reunião Ativa" 
        };

        // Referência à coleção pública de registros
        const REGISTRATIONS_COLLECTION = `artifacts/${appId}/public/data/meeting_registrations`;
        
        // NOVO: Referência ao documento de estado da reunião
        const MEETING_STATE_DOC_PATH = `artifacts/${appId}/public/data/meeting_state/current_meeting`;

        // --- Funções de Utilitário ---

        // Exibe mensagens de status na tela
        function showStatusMessage(message, isError = false) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = 'fixed top-4 right-4 p-4 rounded-xl shadow-2xl font-medium transition-opacity duration-300 z-50';
            
            if (isError) {
                statusEl.classList.add('bg-red-600', 'text-white');
            } else {
                statusEl.classList.add('bg-brand-success', 'text-white'); 
            }
            
            statusEl.classList.remove('opacity-0', 'pointer-events-none');
            statusEl.classList.add('opacity-100');

            setTimeout(() => {
                statusEl.classList.remove('opacity-100');
                statusEl.classList.add('opacity-0', 'pointer-events-none');
            }, 5000);
        }

        // Gera um código de validação de 6 dígitos
        function generateValidationCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Formata a data de hoje como YYYY-MM-DD
        function getTodayDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Formata a data de YYYY-MM-DD para DD/MM/YYYY
        function formatDateToBR(dateString) {
            if (!dateString) return '--/--/----';
            const parts = dateString.split('-'); // Espera YYYY-MM-DD
            if (parts.length === 3) {
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            return dateString; // Retorna original se não estiver no formato esperado
        }
        
        // --- Modal de Confirmação (Substitui confirm()) ---
        function openConfirmationModal(message, confirmAction) {
            const modal = document.getElementById('confirmation-modal');
            const modalContent = document.getElementById('modal-content');
            document.getElementById('modal-text').textContent = message;

            // Transição de entrada
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);

            return new Promise((resolve) => {
                const onConfirm = () => {
                    closeModal();
                    resolve(true);
                };
                const onCancel = () => {
                    closeModal();
                    resolve(false);
                };

                const confirmButton = document.getElementById('modal-confirm');
                const cancelButton = document.getElementById('modal-cancel');
                
                // Remove listeners antigos para evitar duplicação
                confirmButton.onclick = null;
                cancelButton.onclick = null;
                
                // Adiciona novos listeners
                confirmButton.onclick = onConfirm;
                cancelButton.onclick = onCancel;
            });
        }

        function closeModal() {
            const modal = document.getElementById('confirmation-modal');
            const modalContent = document.getElementById('modal-content');
            
            // Transição de saída
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); // Deve corresponder à duração da transição CSS
        }
        
        // --- 1. Lógica de Autenticação (Setup Inicial) ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Usuário autenticado:", userId);
            } else {
                try {
                    // Tenta o login com o token customizado
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        // Se não houver token, faz login anônimo
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Erro na autenticação inicial:", error);
                }
            }
            isAuthReady = true;
            
            // Inicia o listener de estado e quórum
            setupMeetingStateListener(); 
        });

        // --- 2. Controle de Navegação (SPA) ---
        const viewSections = document.querySelectorAll('.view-section');
        
        // Função para trocar a visualização
        function switchView(targetId) {
            viewSections.forEach(section => {
                section.classList.add('hidden');
            });
            const targetElement = document.getElementById(targetId);
            if(targetElement) {
                targetElement.classList.remove('hidden');
            }

            // Atualiza os listeners dependendo da seção
            if (targetId === 'quorum' && isAuthReady) {
                // O listener do quórum é iniciado pelo listener do estado da reunião, 
                // mas garantimos a atualização do gráfico aqui
                updateQuorumCharts(registrationsData); 
            } else if (targetId === 'admin-dashboard' && isAuthReady) {
                setupAdminDashboard(); // Atualiza o dashboard
            }
            
            // Certifica-se de que se não for a main-cards-view, ela está escondida
            if (targetId !== 'main-cards-view') {
                 document.getElementById('main-cards-view').classList.add('hidden');
            }
        }
        
        // Função unificada para lidar com cliques de navegação (Cards)
        function handleViewSwitch(requestedTarget) {
            let targetId = requestedTarget;
            
            // Lógica para o botão Admin
            if (requestedTarget === 'admin-login') {
                 // Verifica se o dashboard admin foi carregado e não está escondido
                 if (document.getElementById('admin-dashboard') && !document.getElementById('admin-dashboard').classList.contains('hidden')) {
                     targetId = 'admin-dashboard'; // Se já estiver logado, vai direto para o dashboard
                 } else {
                     targetId = 'admin-login'; // Caso contrário, vai para o formulário de login
                 }
            }
            switchView(targetId);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Define a visualização inicial: main-cards-view
            switchView('main-cards-view'); 

            // Adiciona listener ao cabeçalho (logo/título) para voltar ao Menu Principal
            document.getElementById('main-header').addEventListener('click', () => {
                switchView('main-cards-view');
            });
            
            // Adiciona listeners aos botões da galeria (cards)
            document.addEventListener('click', (e) => {
                const card = e.target.closest('.menu-card-btn');
                if (card) {
                    handleViewSwitch(card.dataset.target);
                }
            });
        });
        
        // --- 3. Gestão do Estado da Reunião (NOVO) ---
        
        /**
         * Atualiza o estado da UI baseado no estado da reunião atual.
         */
        function updateUIOnMeetingStateChange() {
            // Indicador no Menu Principal
            const indicatorEl = document.getElementById('meeting-status-indicator');
            const registroBtn = document.getElementById('btn-registro');
            const registroAlert = document.getElementById('registro-alert');
            const registroForm = document.getElementById('registration-form');

            if (meetingState.isActive) {
                indicatorEl.className = 'text-center mb-6 p-3 rounded-lg shadow-inner font-semibold text-lg bg-brand-success/20 text-brand-primary';
                indicatorEl.innerHTML = `✅ REUNIÃO ATIVA: <span class="font-extrabold">${meetingState.meetingName || 'Sem Nome'}</span> - Data: ${formatDateToBR(meetingState.meetingId)}`;
                
                registroBtn.disabled = false;
                registroBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                registroAlert.classList.add('hidden');
                if (registroForm) registroForm.style.pointerEvents = 'auto';

                // Atualiza a data do Quórum
                document.getElementById('current-date').textContent = formatDateToBR(meetingState.meetingId);

            } else {
                indicatorEl.className = 'text-center mb-6 p-3 rounded-lg shadow-inner font-semibold text-lg bg-red-100 text-red-700';
                indicatorEl.innerHTML = `❌ REUNIÃO FECHADA.`;
                
                registroBtn.disabled = true;
                registroBtn.classList.add('opacity-50', 'cursor-not-allowed');
                registroAlert.classList.remove('hidden');
                if (registroForm) registroForm.style.pointerEvents = 'none';

                // Se não há reunião ativa, exibe a data de hoje para referência
                document.getElementById('current-date').textContent = formatDateToBR(getTodayDate()) + ' (Fechada)';
            }
            
            // Se estiver no admin dashboard, atualiza os controles lá também
            if (!document.getElementById('admin-dashboard').classList.contains('hidden')) {
                setupAdminDashboard();
            }
        }

        /**
         * Listener em tempo real para o estado da reunião.
         */
        function setupMeetingStateListener() {
            if (!isAuthReady) return;
            
            const docRef = doc(db, MEETING_STATE_DOC_PATH);

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    meetingState = docSnap.data();
                    console.log("Estado da Reunião Atualizado:", meetingState);
                } else {
                    // Se o documento não existir, define como estado padrão (fechado)
                    meetingState = { isActive: false, meetingId: null, meetingName: "Nenhuma Reunião Ativa" };
                    console.log("Documento de estado não existe. Reunião definida como fechada.");
                }

                // Dispara o listener de registros com a nova data da reunião
                setupQuorumListener(meetingState.meetingId);
                updateUIOnMeetingStateChange();

            }, (error) => {
                console.error("Erro ao ouvir o estado da reunião:", error);
                showStatusMessage("Erro ao carregar estado da reunião.", true);
            });
        }
        
        // --- 4. Lógica do Formulário de Registro (1ª Função) ---
        
        document.getElementById('registration-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthReady) {
                showStatusMessage("Aguarde a inicialização do sistema...", true);
                return;
            }
            
            // VERIFICA SE A REUNIÃO ESTÁ ATIVA
            if (!meetingState.isActive) {
                 showStatusMessage("O registro de presença está fechado pelo Administrador.", true);
                 return;
            }

            const name = document.getElementById('name').value.trim();
            const cpf = document.getElementById('cpf').value.trim();
            const institution = document.getElementById('institution').value.trim();
            const sector = document.getElementById('sector').value;
            const representation = document.getElementById('representation').value;
            
            // Usa a data da reunião ativa, não a data de hoje (para reuniões retroativas/agendadas)
            const meetingDate = meetingState.meetingId; 
            
            const validationCode = generateValidationCode();
            
            try {
                // 1. Verificar Duplicidade (CPF na reunião ATIVA)
                const q = query(collection(db, REGISTRATIONS_COLLECTION), 
                                where("cpf", "==", cpf), 
                                where("date", "==", meetingDate));
                
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    showStatusMessage(`Seu CPF já está registrado para a reunião de ${formatDateToBR(meetingDate)}.`, true);
                    return;
                }
                
                // 2. Registrar Transação (para minimizar conflitos simultâneos)
                await runTransaction(db, async (transaction) => {
                    // Refaz a verificação dentro da transação (melhor prática para garantir atomicidade)
                    const reCheck = await getDocs(q);
                    if (!reCheck.empty) {
                        throw "Duplicidade detectada por transação."; // Lança erro para abortar a transação
                    }
                    
                    const newRegistration = {
                        name,
                        cpf,
                        institution,
                        sector,
                        representation,
                        date: meetingDate, // Usa a data da reunião ativa
                        validationCode,
                        timestamp: new Date()
                    };
                    
                    // Adiciona o novo documento
                    const docRef = doc(collection(db, REGISTRATIONS_COLLECTION));
                    transaction.set(docRef, newRegistration);
                    
                    showStatusMessage(`Presença registrada com sucesso! Código de Validação: ${validationCode}`, false);
                    document.getElementById('registration-form').reset(); // Limpa o formulário
                    
                    // Após o registro, retorna para a tela de Cards
                    switchView('main-cards-view'); 
                });

            } catch (error) {
                if (error === "Duplicidade detectada por transação.") {
                    showStatusMessage(`Duplicidade: Seu CPF já foi registrado para a reunião ativa.`, true);
                } else {
                    console.error("Erro ao registrar a frequência:", error);
                    showStatusMessage(`Erro ao registrar: ${error.message || 'Tente novamente.'}`, true);
                }
            }
        });

        // --- 5. Lógica do Gráfico de Quórum (2ª Função) ---
        
        let sectorChart = null;
        let representationChart = null;
        // Variável para armazenar a função de unsubscribe do onSnapshot
        let unsubscribeQuorum = null; 
        
        // Cores do gráfico baseadas na nova paleta
        const chartColors = ['#176781', '#eac066', '#50c2ab', '#7fb2c7', '#67686a'];

        function updateQuorumCharts(data) {
            const meetingDate = meetingState.meetingId || getTodayDate(); // Usa data da reunião ou a de hoje se não houver
            document.getElementById('current-date').textContent = meetingState.isActive ? formatDateToBR(meetingDate) : formatDateToBR(meetingDate) + ' (Fechada)';
            
            // Filtra os dados apenas para a reunião ATIVA
            const todayData = data.filter(r => r.date === meetingState.meetingId);
            
            document.getElementById('total-presentes').textContent = todayData.length;

            // Agrega dados por Setor
            const sectorCounts = todayData.reduce((acc, curr) => {
                acc[curr.sector] = (acc[curr.sector] || 0) + 1;
                return acc;
            }, {});
            
            // Agrega dados por Representação
            const representationCounts = todayData.reduce((acc, curr) => {
                acc[curr.representation] = (acc[curr.representation] || 0) + 1;
                return acc;
            }, {});

            const sectorLabels = Object.keys(sectorCounts);
            const sectorValues = Object.values(sectorCounts);
            
            const repLabels = Object.keys(representationCounts);
            const repValues = Object.values(representationCounts);
            
            // Atualiza Gráfico de Setores
            if (sectorChart) sectorChart.destroy();
            const sectorCtx = document.getElementById('sectorChart').getContext('2d');
            // Chart é uma variável global
            sectorChart = new Chart(sectorCtx, {
                type: 'pie',
                data: {
                    labels: sectorLabels,
                    datasets: [{
                        label: 'Presença por Setor',
                        data: sectorValues,
                        backgroundColor: sectorLabels.map((_, i) => chartColors[i % chartColors.length]),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    }
                }
            });
            
            // Atualiza Gráfico de Representação
            if (representationChart) representationChart.destroy();
            const repCtx = document.getElementById('representationChart').getContext('2d');
            // Chart é uma variável global
            representationChart = new Chart(repCtx, {
                type: 'doughnut',
                data: {
                    labels: repLabels,
                    datasets: [{
                        label: 'Presença por Representação',
                        data: repValues,
                        backgroundColor: repLabels.map((_, i) => chartColors[i % chartColors.length]),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    }
                }
            });
        }
        
        /**
         * Listener em Tempo Real (onSnapshot) para Quórum, filtrado pela reunião ativa.
         */
        function setupQuorumListener(meetingDateId) {
            if (!isAuthReady) return;

            // Cancela o listener anterior, se houver
            if (unsubscribeQuorum) {
                unsubscribeQuorum();
            }
            
            if (meetingDateId) {
                 // Filtra os registros para a reunião ativa (meetingId)
                 const q = query(collection(db, REGISTRATIONS_COLLECTION),
                                 where("date", "==", meetingDateId));
                                 
                 unsubscribeQuorum = onSnapshot(q, (snapshot) => {
                    registrationsData = [];
                    snapshot.forEach((doc) => {
                        registrationsData.push({ id: doc.id, ...doc.data() });
                    });
                    console.log(`Dados de registro atualizados (onSnapshot) para a reunião ${meetingDateId}. Total: ${registrationsData.length}`);
                    updateQuorumCharts(registrationsData);
                    
                    // Se o admin estiver logado, atualiza a tabela também
                    if (!document.getElementById('admin-dashboard').classList.contains('hidden')) {
                        renderAdminTable(registrationsData);
                    }
                }, (error) => {
                    console.error("Erro ao ouvir atualizações do Quórum:", error);
                    showStatusMessage("Erro ao carregar dados do quórum.", true);
                });
            } else {
                // Se não houver meetingDateId, limpa os dados
                registrationsData = [];
                console.log("Nenhuma reunião ativa. Dados de registro limpos.");
                updateQuorumCharts(registrationsData);
            }
        }


        // --- 6. Lógica da Área Administrativa (3ª Função) ---

        // 6.1 Login
        document.getElementById('admin-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('admin-login-error');
            
            if (password === ADMIN_PASSWORD) {
                errorEl.textContent = "";
                // Muda a visualização
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                
                // Configura o dashboard
                setupAdminDashboard();
                
            } else {
                errorEl.textContent = "Senha incorreta. Tente novamente.";
                showStatusMessage("Senha de Admin incorreta.", true);
            }
        });

        // 6.2 Setup do Dashboard Admin
        function setupAdminDashboard() {
            const statusEl = document.getElementById('admin-meeting-status');
            const startBtn = document.getElementById('start-meeting');
            const endBtn = document.getElementById('end-meeting');
            const resetBtn = document.getElementById('reset-quorum-today');
            const adminDateEl = document.getElementById('admin-meeting-date');
            
            adminDateEl.textContent = formatDateToBR(meetingState.meetingId) || '--';

            if (meetingState.isActive) {
                statusEl.className = 'mb-4 p-3 rounded-lg text-center font-semibold text-lg bg-brand-success/20 text-brand-primary';
                statusEl.innerHTML = `✅ REUNIÃO EM CURSO: ${meetingState.meetingName} (Data: ${formatDateToBR(meetingState.meetingId)})`;
                startBtn.disabled = true;
                startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                endBtn.disabled = false;
                endBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                resetBtn.disabled = false;
                resetBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                statusEl.className = 'mb-4 p-3 rounded-lg text-center font-semibold text-lg bg-red-100 text-red-700';
                statusEl.innerHTML = `❌ REUNIÃO FECHADA.`;
                startBtn.disabled = false;
                startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                endBtn.disabled = true;
                endBtn.classList.add('opacity-50', 'cursor-not-allowed');
                resetBtn.disabled = true;
                resetBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            // Reusa os dados do listener do quórum que está ativo
            renderAdminTable(registrationsData);
        }

        // 6.3 Lógica dos Botões de Controle (Iniciar/Finalizar/Resetar)
        
        // Ações: Iniciar Reunião
        document.getElementById('start-meeting').addEventListener('click', async () => {
            const today = getTodayDate();
            // Pede um nome para a reunião (poderia ser um prompt mais elaborado)
            const meetingName = prompt("Digite o NOME da nova reunião (ex: Reunião Ordinária 2025):") || `Reunião ${formatDateToBR(today)}`;

            if (meetingName) {
                try {
                    await setDoc(doc(db, MEETING_STATE_DOC_PATH), {
                        isActive: true,
                        meetingId: today, // Usa a data de hoje como ID da reunião (YYYY-MM-DD)
                        meetingName: meetingName
                    });
                    showStatusMessage(`Nova reunião (${meetingName}) iniciada com sucesso na data ${formatDateToBR(today)}!`);
                } catch (error) {
                    console.error("Erro ao iniciar a reunião:", error);
                    showStatusMessage("Erro ao iniciar a reunião.", true);
                }
            } else {
                 showStatusMessage("O nome da reunião não pode ser vazio.", true);
            }
        });

        // Ações: Finalizar Reunião
        document.getElementById('end-meeting').addEventListener('click', async () => {
            try {
                await setDoc(doc(db, MEETING_STATE_DOC_PATH), {
                    isActive: false,
                    meetingId: meetingState.meetingId, // Mantém a referência, mas desativa
                    meetingName: meetingState.meetingName
                });
                showStatusMessage(`Reunião ${meetingState.meetingName} finalizada.`);
            } catch (error) {
                console.error("Erro ao finalizar a reunião:", error);
                showStatusMessage("Erro ao finalizar a reunião.", true);
            }
        });
        
        // NOVO: Ações: Resetar Quórum de Hoje
        document.getElementById('reset-quorum-today').addEventListener('click', async () => {
            if (!meetingState.isActive || !meetingState.meetingId) {
                showStatusMessage("Não há reunião ativa para resetar o quórum.", true);
                return;
            }
            
            const confirmed = await openConfirmationModal(
                `CONFIRMAR: Você tem certeza que deseja APAGAR TODOS os ${registrationsData.length} registros da reunião ativa (${formatDateToBR(meetingState.meetingId)})? Esta ação é irreversível.`, 
                () => deleteMeetingRecords(meetingState.meetingId)
            );
            
            if (confirmed) {
                await deleteMeetingRecords(meetingState.meetingId);
            } else {
                showStatusMessage("Operação de reset cancelada.", false);
            }
        });
        
        /**
         * Executa a exclusão de todos os registros de uma reunião específica.
         * @param {string} meetingDateId O ID (data) da reunião a ser apagada.
         */
        async function deleteMeetingRecords(meetingDateId) {
            try {
                const q = query(collection(db, REGISTRATIONS_COLLECTION), 
                                where("date", "==", meetingDateId));
                                
                const snapshot = await getDocs(q);
                
                let deletedCount = 0;
                
                // Deletar em lote (importante para evitar timeouts longos)
                for (const docSnapshot of snapshot.docs) {
                    await deleteDoc(doc(db, REGISTRATIONS_COLLECTION, docSnapshot.id));
                    deletedCount++;
                }

                showStatusMessage(`Sucesso! ${deletedCount} registros da reunião ${formatDateToBR(meetingDateId)} foram apagados.`, false);
                
            } catch (error) {
                console.error("Erro ao apagar registros:", error);
                showStatusMessage(`Erro ao resetar quórum: ${error.message || 'Tente novamente.'}`, true);
            }
        }
        

        // 6.4 Renderização da Tabela
        function renderAdminTable(data) {
            const tableBody = document.getElementById('admin-table-body');
            const loadingMsg = document.getElementById('admin-loading-message');
            tableBody.innerHTML = '';
            
            // Filtra os dados apenas para a reunião ATIVA (isso é a chave)
            const filteredData = data.filter(reg => reg.date === meetingState.meetingId);
            
            if (filteredData.length === 0) {
                loadingMsg.textContent = meetingState.isActive ? "Nenhum registro encontrado para esta reunião." : "Aguardando o início de uma nova reunião.";
                loadingMsg.classList.remove('hidden');
                return;
            }
            loadingMsg.classList.add('hidden');

            // Ordena por data/hora mais recente primeiro
            filteredData.sort((a, b) => {
                const dateA = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                const dateB = b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                return dateB - dateA;
            });

            filteredData.forEach(reg => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-100 transition duration-150';
                
                const dateObj = reg.timestamp.toDate ? reg.timestamp.toDate() : new Date(reg.timestamp);
                const timeString = dateObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                row.insertCell().textContent = reg.id.substring(0, 4) + '...'; // ID abreviado
                row.insertCell().textContent = reg.name;
                row.insertCell().textContent = reg.cpf;
                row.insertCell().textContent = reg.sector;
                row.insertCell().textContent = reg.representation;
                row.insertCell().textContent = reg.validationCode;
                row.insertCell().textContent = `${formatDateToBR(reg.date)} (${timeString})`;
            });
        }
        
        // 6.5 Download CSV (Filtrado pela Reunião Ativa)
        document.getElementById('download-csv').addEventListener('click', () => {
             // Garante que só exporta os dados da reunião ativa
            const dataToExport = registrationsData.filter(reg => reg.date === meetingState.meetingId);
            
            if (dataToExport.length === 0) {
                showStatusMessage("Nenhum dado para exportar na reunião ativa.", true);
                return;
            }

            const meetingDate = meetingState.meetingId || getTodayDate(); // Usa a data da reunião ativa
            
            let csv = "ID,Nome,CPF,Instituicao,Setor,Representacao,Codigo_Validacao,Data_Reuniao,Timestamp\n";
            
            dataToExport.forEach(reg => {
                const dateObj = reg.timestamp.toDate ? reg.timestamp.toDate() : new Date(reg.timestamp);
                const timestampString = dateObj.toISOString();

                // Garante que a data no CSV está no formato YYYY-MM-DD
                csv += `${reg.id},"${reg.name}","${reg.cpf}","${reg.institution}","${reg.sector}","${reg.representation}",${reg.validationCode},${reg.date},${timestampString}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                // Nome do arquivo com a data YYYY-MM-DD
                link.setAttribute("download", `frequencia_reuniao_${meetingDate}.csv`); 
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showStatusMessage("CSV gerado com sucesso!", false);
            }
        });

        // 6.6 Download PDF (Filtrado pela Reunião Ativa)
        document.getElementById('download-pdf').addEventListener('click', () => {
            // Garante que só exporta os dados da reunião ativa
            const dataToExport = registrationsData.filter(reg => reg.date === meetingState.meetingId);
            
            if (dataToExport.length === 0) {
                showStatusMessage("Nenhum dado para exportar na reunião ativa.", true);
                return;
            }

            // A data da reunião no formato YYYY-MM-DD
            const todayStr_YYYYMMDD = meetingState.meetingId || getTodayDate(); 
            // Converte para DD/MM/YYYY
            const todayStr_DDMMYYYY = formatDateToBR(todayStr_YYYYMMDD); 
            
            // Acessa o construtor jsPDF através do objeto global 'jspdf'
            const doc = new jspdf.jsPDF(); 
            
            // 2. ADICIONAR O CABEÇALHO PERSONALIZADO
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text("Comitê de Bacia Hidrográfica do Lago de Palmas", doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
            
            // CORREÇÃO APLICADA AQUI: Subtítulo simplificado
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            // Texto: Registro de Frequência da Reunião realizada em: Data
            doc.text(`Registro de Frequência da Reunião realizada em: ${todayStr_DDMMYYYY}`, doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' });


            // 3. PREPARAR DADOS PARA autoTable
            const headers = [["Nome", "Instituição/Órgão", "Setor", "Representação", "Cód. Validação"]];
            
            const body = dataToExport
                // Ordena por nome alfabeticamente para a lista de presença
                .sort((a, b) => a.name.localeCompare(b.name)) 
                .map(reg => {
                    return [
                        reg.name,
                        reg.institution,
                        reg.sector,
                        reg.representation,
                        reg.validationCode
                    ];
                });

            // 4. RENDERIZAR A TABELA USANDO autoTable
            
            // Verifica se a função autoTable está disponível
            if (typeof doc.autoTable === 'undefined') {
                showStatusMessage("Erro: jspdf-autotable não carregado. Verifique as dependências.", true);
                return;
            }

            doc.autoTable({
                startY: 40,
                head: headers,
                body: body,
                theme: 'striped', // Tema listrado
                styles: {
                    font: 'helvetica',
                    fontSize: 9, // Tamanho da fonte menor
                    cellPadding: 1.5,
                    lineWidth: 0.1, 
                    lineColor: '#e0e0e0'
                },
                headStyles: {
                    fillColor: [23, 103, 129], // brand-primary: #176781
                    textColor: 255, // Branco
                    fontStyle: 'bold',
                    fontSize: 10
                },
                // Ajuste de largura das colunas
                columnStyles: {
                    0: { cellWidth: 50 }, // Nome
                    1: { cellWidth: 50 }, // Instituição/Órgão
                    2: { cellWidth: 30 }, // Setor
                    3: { cellWidth: 30 }, // Representação
                    4: { cellWidth: 30 }, // Código
                },
                didDrawPage: (data) => {
                    // Adiciona rodapé com número de página
                    doc.setFontSize(8);
                    doc.text("Página " + data.pageNumber, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            // Pega a posição Y final da tabela
            let y = doc.autoTable.previous.finalY;

            // 5. ADICIONAR O LINK DE VALIDAÇÃO
            y += 20; // Espaço após a tabela
            
            // Verifica se precisa de nova página para o link
            if (y > doc.internal.pageSize.height - 20) { 
                doc.addPage();
                y = 20;
            }
            
            doc.setFontSize(9);
            doc.setFont("helvetica", "italic");
            doc.setTextColor(0, 0, 0); // Volta a cor padrão
            doc.text("Valide este e outros registros no portal oficial:", 10, y);
            y += 5;
            
            const siteLink = window.location.href; // Pega a URL atual
            doc.setTextColor(40, 58, 119); // Cor de link (azul)
            doc.textWithLink(siteLink, 10, y, { url: siteLink });
            
            // Volta a cor de texto padrão
            doc.setTextColor(0, 0, 0);

            doc.save(`frequencia_reuniao_${todayStr_YYYYMMDD}.pdf`);
            showStatusMessage("PDF gerado com sucesso!", false);
        });


        // --- 7. Lógica de Validação (4ª Função) ---
        
        document.getElementById('validation-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAuthReady) {
                showStatusMessage("Aguarde a inicialização do sistema...", true);
                return;
            }

            const code = document.getElementById('validation-code-input').value.trim();
            const resultEl = document.getElementById('validation-result');
            resultEl.classList.add('hidden');

            if (code.length !== 6) {
                showStatusMessage("O código deve ter 6 dígitos.", true);
                return;
            }

            try {
                // Busca o registro pelo código de validação
                const q = query(collection(db, REGISTRATIONS_COLLECTION), 
                                where("validationCode", "==", code));
                
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    // Estilo para Erro/Não Encontrado
                    resultEl.className = 'mt-6 p-6 rounded-xl bg-red-100 text-red-800 font-medium shadow-xl border-l-4 border-red-500';
                    resultEl.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-octagon"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                            <p class="font-bold text-lg">CÓDIGO NÃO ENCONTRADO!</p>
                        </div>
                        <p class="mt-2 text-sm">Nenhuma presença registrada com o código <span class="font-mono bg-red-200 px-1 rounded">${code}</span>.</p>
                    `;
                } else {
                    const data = querySnapshot.docs[0].data();
                    // Estilo para Sucesso (com cores da paleta)
                    resultEl.className = 'mt-6 p-6 rounded-xl bg-brand-success/20 text-brand-primary font-medium shadow-xl border-l-4 border-brand-success';
                    resultEl.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle text-brand-success"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M9 11l3 3L22 4"/></svg>
                            <p class="font-bold text-lg text-brand-primary">PRESENÇA CONFIRMADA!</p>
                        </div>
                        <div class="mt-3 space-y-1">
                            <p><strong>Nome:</strong> ${data.name}</p>
                            <p><strong>Instituição:</strong> ${data.institution}</p>
                            <p><strong>Setor:</strong> ${data.sector}</p>
                            <p><strong>Data da Reunião:</strong> <span class="font-semibold">${formatDateToBR(data.date)}</span></p>
                        </div>
                        <p class="mt-3 text-xs italic text-gray-600">Este registro foi feito em ${data.timestamp.toDate().toLocaleString('pt-BR')}.</p>
                    `;
                }
                resultEl.classList.remove('hidden');
            } catch (error) {
                console.error("Erro na validação do código:", error);
                showStatusMessage(`Erro ao validar o código: ${error.message || 'Tente novamente.'}`, true);
            }
        });
        
    </script>
</body>
</html>